"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.bundleImportRewrite = void 0;
const rewrite_bundle_import_1 = require("@ssen/rewrite-bundle-import");
const typescript_1 = __importDefault(require("typescript"));
function createVisitor({ ctx, }) {
    const visitor = (node) => {
        // import from '?'
        if (typescript_1.default.isImportDeclaration(node) &&
            typescript_1.default.isStringLiteralLike(node.moduleSpecifier) &&
            node.moduleSpecifier.text) {
            const importPath = node.moduleSpecifier.text;
            const rewrittenImportPath = rewrite_bundle_import_1.rewriteBundleImport({
                importPath,
            });
            if (importPath !== rewrittenImportPath) {
                return typescript_1.default.factory.updateImportDeclaration(node, node.decorators, node.modifiers, node.importClause, typescript_1.default.factory.createStringLiteral(rewrittenImportPath));
            }
        }
        // import('?')
        else if (typescript_1.default.isCallExpression(node) &&
            node.expression.kind === typescript_1.default.SyntaxKind.ImportKeyword &&
            typescript_1.default.isStringLiteralLike(node.arguments[0])) {
            const importPath = node.arguments[0]
                .text;
            const rewrittenImportPath = rewrite_bundle_import_1.rewriteBundleImport({
                importPath,
            });
            if (importPath !== rewrittenImportPath) {
                return typescript_1.default.factory.updateCallExpression(node, node.expression, node.typeArguments, [
                    typescript_1.default.factory.createStringLiteral(rewrittenImportPath),
                    ...node.arguments.slice(1),
                ]);
            }
        }
        // require.resolve('?')
        else if (typescript_1.default.isCallExpression(node) &&
            typescript_1.default.isPropertyAccessExpression(node.expression) &&
            typescript_1.default.isIdentifier(node.expression.expression) &&
            node.expression.expression.escapedText === 'require' &&
            node.expression.name.escapedText === 'resolve' &&
            typescript_1.default.isStringLiteralLike(node.arguments[0])) {
            const importPath = node.arguments[0]
                .text;
            const rewrittenImportPath = rewrite_bundle_import_1.rewriteBundleImport({
                importPath,
            });
            if (importPath !== rewrittenImportPath) {
                return typescript_1.default.factory.updateCallExpression(node, node.expression, node.typeArguments, [
                    typescript_1.default.factory.createStringLiteral(rewrittenImportPath),
                    ...node.arguments.slice(1),
                ]);
            }
        }
        // require('?')
        else if (typescript_1.default.isCallExpression(node) &&
            typescript_1.default.isIdentifier(node.expression) &&
            node.expression.escapedText === 'require' &&
            typescript_1.default.isStringLiteralLike(node.arguments[0])) {
            const importPath = node.arguments[0]
                .text;
            const rewrittenImportPath = rewrite_bundle_import_1.rewriteBundleImport({
                importPath,
            });
            if (importPath !== rewrittenImportPath) {
                return typescript_1.default.factory.updateCallExpression(node, node.expression, node.typeArguments, [
                    typescript_1.default.factory.createStringLiteral(rewrittenImportPath),
                    ...node.arguments.slice(1),
                ]);
            }
        }
        return typescript_1.default.visitEachChild(node, visitor, ctx);
    };
    return visitor;
}
const bundleImportRewrite = (config) => (ctx) => (node) => {
    return typescript_1.default.visitNode(node, createVisitor({ ...config, ctx }));
};
exports.bundleImportRewrite = bundleImportRewrite;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvQHNzZW4vYnVuZGxlLWltcG9ydC1yZXdyaXRlL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLHVFQUFrRTtBQUNsRSw0REFBNEI7QUFJNUIsU0FBUyxhQUFhLENBQUMsRUFDckIsR0FBRyxHQUMrQztJQUNsRCxNQUFNLE9BQU8sR0FBZSxDQUFDLElBQWEsRUFBVyxFQUFFO1FBQ3JELGtCQUFrQjtRQUNsQixJQUNFLG9CQUFFLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDO1lBQzVCLG9CQUFFLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQztZQUM1QyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksRUFDekI7WUFDQSxNQUFNLFVBQVUsR0FBVyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQztZQUNyRCxNQUFNLG1CQUFtQixHQUFXLDJDQUFtQixDQUFDO2dCQUN0RCxVQUFVO2FBQ1gsQ0FBQyxDQUFDO1lBRUgsSUFBSSxVQUFVLEtBQUssbUJBQW1CLEVBQUU7Z0JBQ3RDLE9BQU8sb0JBQUUsQ0FBQyxPQUFPLENBQUMsdUJBQXVCLENBQ3ZDLElBQUksRUFDSixJQUFJLENBQUMsVUFBVSxFQUNmLElBQUksQ0FBQyxTQUFTLEVBQ2QsSUFBSSxDQUFDLFlBQVksRUFDakIsb0JBQUUsQ0FBQyxPQUFPLENBQUMsbUJBQW1CLENBQUMsbUJBQW1CLENBQUMsQ0FDcEQsQ0FBQzthQUNIO1NBQ0Y7UUFDRCxjQUFjO2FBQ1QsSUFDSCxvQkFBRSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQztZQUN6QixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksS0FBSyxvQkFBRSxDQUFDLFVBQVUsQ0FBQyxhQUFhO1lBQ3BELG9CQUFFLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUN6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QU8sT0FBTyxDQUFDO0FBQ2pCLENBQUM7QUFFTSxNQUFNLG1CQUFtQixHQUM5QixDQUFDLE1BQXFCLEVBQXdDLEVBQUUsQ0FDaEUsQ0FBQyxHQUE2QixFQUFFLEVBQUUsQ0FDbEMsQ0FBQyxJQUFtQixFQUFFLEVBQUU7SUFDdEIsT0FBTyxvQkFBRSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsYUFBYSxDQUFDLEVBQUUsR0FBRyxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBQy9ELENBQUMsQ0FBQztBQUxTLFFBQUEsbUJBQW1CLHVCQUs1QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHJld3JpdGVCdW5kbGVJbXBvcnQgfSBmcm9tICdAc3Nlbi9yZXdyaXRlLWJ1bmRsZS1pbXBvcnQnO1xuaW1wb3J0IHRzIGZyb20gJ3R5cGVzY3JpcHQnO1xuXG5pbnRlcmZhY2UgQ29uZmlndXJhdGlvbiB7fVxuXG5mdW5jdGlvbiBjcmVhdGVWaXNpdG9yKHtcbiAgY3R4LFxufTogQ29uZmlndXJhdGlvbiAmIHsgY3R4OiB0cy5UcmFuc2Zvcm1hdGlvbkNvbnRleHQgfSk6IHRzLlZpc2l0b3Ige1xuICBjb25zdCB2aXNpdG9yOiB0cy5WaXNpdG9yID0gKG5vZGU6IHRzLk5vZGUpOiB0cy5Ob2RlID0+IHtcbiAgICAvLyBpbXBvcnQgZnJvbSAnPydcbiAgICBpZiAoXG4gICAgICB0cy5pc0ltcG9ydERlY2xhcmF0aW9uKG5vZGUpICYmXG4gICAgICB0cy5pc1N0cmluZ0xpdGVyYWxMaWtlKG5vZGUubW9kdWxlU3BlY2lmaWVyKSAmJlxuICAgICAgbm9kZS5tb2R1bGVTcGVjaWZpZXIudGV4dFxuICAgICkge1xuICAgICAgY29uc3QgaW1wb3J0UGF0aDogc3RyaW5nID0gbm9kZS5tb2R1bGVTcGVjaWZpZXIudGV4dDtcbiAgICAgIGNvbnN0IHJld3JpdHRlbkltcG9ydFBhdGg6IHN0cmluZyA9IHJld3JpdGVCdW5kbGVJbXBvcnQoe1xuICAgICAgICBpbXBvcnRQYXRoLFxuICAgICAgfSk7XG5cbiAgICAgIGlmIChpbXBvcnRQYXRoICE9PSByZXdyaXR0ZW5JbXBvcnRQYXRoKSB7XG4gICAgICAgIHJldHVybiB0cy5mYWN0b3J5LnVwZGF0ZUltcG9ydERlY2xhcmF0aW9uKFxuICAgICAgICAgIG5vZGUsXG4gICAgICAgICAgbm9kZS5kZWNvcmF0b3JzLFxuICAgICAgICAgIG5vZGUubW9kaWZpZXJzLFxuICAgICAgICAgIG5vZGUuaW1wb3J0Q2xhdXNlLFxuICAgICAgICAgIHRzLmZhY3RvcnkuY3JlYXRlU3RyaW5nTGl0ZXJhbChyZXdyaXR0ZW5JbXBvcnRQYXRoKSxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gaW1wb3J0KCc/JylcbiAgICBlbHNlIGlmIChcbiAgICAgIHRzLmlzQ2FsbEV4cHJlc3Npb24obm9kZSkgJiZcbiAgICAgIG5vZGUuZXhwcmVzc2lvbi5raW5kID09PSB0cy5TeW50YXhLaW5kLkltcG9ydEtleXdvcmQgJiZcbiAgICAgIHRzLmlzU3RyaW5nTGl0ZXJhbExpa2Uobm9kZS5hcmd1bWVudHNbMF0pXG4gICAgKSB7XG4gICAgICBjb25zdCBpbXBvcnRQYXRoOiBzdHJpbmcgPSAobm9kZS5hcmd1bWVudHNbMF0gYXMgdHMuU3RyaW5nTGl0ZXJhbExpa2UpXG4gICAgICAgIC50ZXh0O1xuICAgICAgY29uc3QgcmV3cml0dGVuSW1wb3J0UGF0aDogc3RyaW5nID0gcmV3cml0ZUJ1bmRsZUltcG9ydCh7XG4gICAgICAgIGltcG9ydFBhdGgsXG4gICAgICB9KTtcblxuICAgICAgaWYgKGltcG9ydFBhdGggIT09IHJld3JpdHRlbkltcG9ydFBhdGgpIHtcbiAgICAgICAgcmV0dXJuIHRzLmZhY3RvcnkudXBkYXRlQ2FsbEV4cHJlc3Npb24oXG4gICAgICAgICAgbm9kZSxcbiAgICAgICAgICBub2RlLmV4cHJlc3Npb24sXG4gICAgICAgICAgbm9kZS50eXBlQXJndW1lbnRzLFxuICAgICAgICAgIFtcbiAgICAgICAgICAgIHRzLmZhY3RvcnkuY3JlYXRlU3RyaW5nTGl0ZXJhbChyZXdyaXR0ZW5JbXBvcnRQYXRoKSxcbiAgICAgICAgICAgIC4uLm5vZGUuYXJndW1lbnRzLnNsaWNlKDEpLFxuICAgICAgICAgIF0sXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICAgIC8vIHJlcXVpcmUucmVzb2x2ZSgnPycpXG4gICAgZWxzZSBpZiAoXG4gICAgICB0cy5pc0NhbGxFeHByZXNzaW9uKG5vZGUpICYmXG4gICAgICB0cy5pc1Byb3BlcnR5QWNjZXNzRXhwcmVzc2lvbihub2RlLmV4cHJlc3Npb24pICYmXG4gICAgICB0cy5pc0lkZW50aWZpZXIobm9kZS5leHByZXNzaW9uLmV4cHJlc3Npb24pICYmXG4gICAgICBub2RlLmV4cHJlc3Npb24uZXhwcmVzc2lvbi5lc2NhcGVkVGV4dCA9PT0gJ3JlcXVpcmUnICYmXG4gICAgICBub2RlLmV4cHJlc3Npb24ubmFtZS5lc2NhcGVkVGV4dCA9PT0gJ3Jlc29sdmUnICYmXG4gICAgICB0cy5pc1N0cmluZ0xpdGVyYWxMaWtlKG5vZGUuYXJndW1lbnRzWzBdKVxuICAgICkge1xuICAgICAgY29uc3QgaW1wb3J0UGF0aDogc3RyaW5nID0gKG5vZGUuYXJndW1lbnRzWzBdIGFzIHRzLlN0cmluZ0xpdGVyYWxMaWtlKVxuICAgICAgICAudGV4dDtcbiAgICAgIGNvbnN0IHJld3JpdHRlbkltcG9ydFBhdGg6IHN0cmluZyA9IHJld3JpdGVCdW5kbGVJbXBvcnQoe1xuICAgICAgICBpbXBvcnRQYXRoLFxuICAgICAgfSk7XG5cbiAgICAgIGlmIChpbXBvcnRQYXRoICE9PSByZXdyaXR0ZW5JbXBvcnRQYXRoKSB7XG4gICAgICAgIHJldHVybiB0cy5mYWN0b3J5LnVwZGF0ZUNhbGxFeHByZXNzaW9uKFxuICAgICAgICAgIG5vZGUsXG4gICAgICAgICAgbm9kZS5leHByZXNzaW9uLFxuICAgICAgICAgIG5vZGUudHlwZUFyZ3VtZW50cyxcbiAgICAgICAgICBbXG4gICAgICAgICAgICB0cy5mYWN0b3J5LmNyZWF0ZVN0cmluZ0xpdGVyYWwocmV3cml0dGVuSW1wb3J0UGF0aCksXG4gICAgICAgICAgICAuLi5ub2RlLmFyZ3VtZW50cy5zbGljZSgxKSxcbiAgICAgICAgICBdLFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgICAvLyByZXF1aXJlKCc/JylcbiAgICBlbHNlIGlmIChcbiAgICAgIHRzLmlzQ2FsbEV4cHJlc3Npb24obm9kZSkgJiZcbiAgICAgIHRzLmlzSWRlbnRpZmllcihub2RlLmV4cHJlc3Npb24pICYmXG4gICAgICBub2RlLmV4cHJlc3Npb24uZXNjYXBlZFRleHQgPT09ICdyZXF1aXJlJyAmJlxuICAgICAgdHMuaXNTdHJpbmdMaXRlcmFsTGlrZShub2RlLmFyZ3VtZW50c1swXSlcbiAgICApIHtcbiAgICAgIGNvbnN0IGltcG9ydFBhdGg6IHN0cmluZyA9IChub2RlLmFyZ3VtZW50c1swXSBhcyB0cy5TdHJpbmdMaXRlcmFsTGlrZSlcbiAgICAgICAgLnRleHQ7XG4gICAgICBjb25zdCByZXdyaXR0ZW5JbXBvcnRQYXRoOiBzdHJpbmcgPSByZXdyaXRlQnVuZGxlSW1wb3J0KHtcbiAgICAgICAgaW1wb3J0UGF0aCxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoaW1wb3J0UGF0aCAhPT0gcmV3cml0dGVuSW1wb3J0UGF0aCkge1xuICAgICAgICByZXR1cm4gdHMuZmFjdG9yeS51cGRhdGVDYWxsRXhwcmVzc2lvbihcbiAgICAgICAgICBub2RlLFxuICAgICAgICAgIG5vZGUuZXhwcmVzc2lvbixcbiAgICAgICAgICBub2RlLnR5cGVBcmd1bWVudHMsXG4gICAgICAgICAgW1xuICAgICAgICAgICAgdHMuZmFjdG9yeS5jcmVhdGVTdHJpbmdMaXRlcmFsKHJld3JpdHRlbkltcG9ydFBhdGgpLFxuICAgICAgICAgICAgLi4ubm9kZS5hcmd1bWVudHMuc2xpY2UoMSksXG4gICAgICAgICAgXSxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gdHMudmlzaXRFYWNoQ2hpbGQobm9kZSwgdmlzaXRvciwgY3R4KTtcbiAgfTtcblxuICByZXR1cm4gdmlzaXRvcjtcbn1cblxuZXhwb3J0IGNvbnN0IGJ1bmRsZUltcG9ydFJld3JpdGUgPVxuICAoY29uZmlnOiBDb25maWd1cmF0aW9uKTogdHMuVHJhbnNmb3JtZXJGYWN0b3J5PHRzLlNvdXJjZUZpbGU+ID0+XG4gIChjdHg6IHRzLlRyYW5zZm9ybWF0aW9uQ29udGV4dCkgPT5cbiAgKG5vZGU6IHRzLlNvdXJjZUZpbGUpID0+IHtcbiAgICByZXR1cm4gdHMudmlzaXROb2RlKG5vZGUsIGNyZWF0ZVZpc2l0b3IoeyAuLi5jb25maWcsIGN0eCB9KSk7XG4gIH07XG4iXX0=