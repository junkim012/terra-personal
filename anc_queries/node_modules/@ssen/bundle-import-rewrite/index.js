import { rewriteBundleImport } from '@ssen/rewrite-bundle-import';
import ts from 'typescript';
function createVisitor({ ctx, }) {
    const visitor = (node) => {
        // import from '?'
        if (ts.isImportDeclaration(node) &&
            ts.isStringLiteralLike(node.moduleSpecifier) &&
            node.moduleSpecifier.text) {
            const importPath = node.moduleSpecifier.text;
            const rewrittenImportPath = rewriteBundleImport({
                importPath,
            });
            if (importPath !== rewrittenImportPath) {
                return ts.factory.updateImportDeclaration(node, node.decorators, node.modifiers, node.importClause, ts.factory.createStringLiteral(rewrittenImportPath));
            }
        }
        // import('?')
        else if (ts.isCallExpression(node) &&
            node.expression.kind === ts.SyntaxKind.ImportKeyword &&
            ts.isStringLiteralLike(node.arguments[0])) {
            const importPath = node.arguments[0]
                .text;
            const rewrittenImportPath = rewriteBundleImport({
                importPath,
            });
            if (importPath !== rewrittenImportPath) {
                return ts.factory.updateCallExpression(node, node.expression, node.typeArguments, [
                    ts.factory.createStringLiteral(rewrittenImportPath),
                    ...node.arguments.slice(1),
                ]);
            }
        }
        // require.resolve('?')
        else if (ts.isCallExpression(node) &&
            ts.isPropertyAccessExpression(node.expression) &&
            ts.isIdentifier(node.expression.expression) &&
            node.expression.expression.escapedText === 'require' &&
            node.expression.name.escapedText === 'resolve' &&
            ts.isStringLiteralLike(node.arguments[0])) {
            const importPath = node.arguments[0]
                .text;
            const rewrittenImportPath = rewriteBundleImport({
                importPath,
            });
            if (importPath !== rewrittenImportPath) {
                return ts.factory.updateCallExpression(node, node.expression, node.typeArguments, [
                    ts.factory.createStringLiteral(rewrittenImportPath),
                    ...node.arguments.slice(1),
                ]);
            }
        }
        // require('?')
        else if (ts.isCallExpression(node) &&
            ts.isIdentifier(node.expression) &&
            node.expression.escapedText === 'require' &&
            ts.isStringLiteralLike(node.arguments[0])) {
            const importPath = node.arguments[0]
                .text;
            const rewrittenImportPath = rewriteBundleImport({
                importPath,
            });
            if (importPath !== rewrittenImportPath) {
                return ts.factory.updateCallExpression(node, node.expression, node.typeArguments, [
                    ts.factory.createStringLiteral(rewrittenImportPath),
                    ...node.arguments.slice(1),
                ]);
            }
        }
        return ts.visitEachChild(node, visitor, ctx);
    };
    return visitor;
}
export const bundleImportRewrite = (config) => (ctx) => (node) => {
    return ts.visitNode(node, createVisitor({ ...config, ctx }));
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvQHNzZW4vYnVuZGxlLWltcG9ydC1yZXdyaXRlL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQ2xFLE9BQU8sRUFBRSxNQUFNLFlBQVksQ0FBQztBQUk1QixTQUFTLGFBQWEsQ0FBQyxFQUNyQixHQUFHLEdBQytDO0lBQ2xELE1BQU0sT0FBTyxHQUFlLENBQUMsSUFBYSxFQUFXLEVBQUU7UUFDckQsa0JBQWtCO1FBQ2xCLElBQ0UsRUFBRSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQztZQUM1QixFQUFFLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQztZQUM1QyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksRUFDekI7WUFDQSxNQUFNLFVBQVUsR0FBVyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQztZQUNyRCxNQUFNLG1CQUFtQixHQUFXLG1CQUFtQixDQUFDO2dCQUN0RCxVQUFVO2FBQ1gsQ0FBQyxDQUFDO1lBRUgsSUFBSSxVQUFVLEtBQUssbUJBQW1CLEVBQUU7Z0JBQ3RDLE9BQU8sRUFBRSxDQUFDLE9BQU8sQ0FBQyx1QkFBdUIsQ0FDdkMsSUFBSSxFQUNKLElBQUksQ0FBQyxVQUFVLEVBQ2YsSUFBSSxDQUFDLFNBQVMsRUFDZCxJQUFJLENBQUMsWUFBWSxFQUNqQixFQUFFLENBQUMsT0FBTyxDQUFDLG1CQUFtQixDQUFDLG1CQUFtQixDQUFDLENBQ3BELENBQUM7YUFDSDtTQUNGO1FBQ0QsY0FBYzthQUNULElBQ0gsRUFBRSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQztZQUN6QixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksS0FBSyxFQUFFLENBQUMsVUFBVSxDQUFDLGFBQWE7WUFDcEQsRUFBRSxDQUFDLG1CQUFtQixDQUFDLElBQUks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L0MsQ0FBQyxDQUFDO0lBRUYsT0FBTyxPQUFPLENBQUM7QUFDakIsQ0FBQztBQUVELE1BQU0sQ0FBQyxNQUFNLG1CQUFtQixHQUM5QixDQUFDLE1BQXFCLEVBQXdDLEVBQUUsQ0FDaEUsQ0FBQyxHQUE2QixFQUFFLEVBQUUsQ0FDbEMsQ0FBQyxJQUFtQixFQUFFLEVBQUU7SUFDdEIsT0FBTyxFQUFFLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxhQUFhLENBQUMsRUFBRSxHQUFHLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFDL0QsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcmV3cml0ZUJ1bmRsZUltcG9ydCB9IGZyb20gJ0Bzc2VuL3Jld3JpdGUtYnVuZGxlLWltcG9ydCc7XG5pbXBvcnQgdHMgZnJvbSAndHlwZXNjcmlwdCc7XG5cbmludGVyZmFjZSBDb25maWd1cmF0aW9uIHt9XG5cbmZ1bmN0aW9uIGNyZWF0ZVZpc2l0b3Ioe1xuICBjdHgsXG59OiBDb25maWd1cmF0aW9uICYgeyBjdHg6IHRzLlRyYW5zZm9ybWF0aW9uQ29udGV4dCB9KTogdHMuVmlzaXRvciB7XG4gIGNvbnN0IHZpc2l0b3I6IHRzLlZpc2l0b3IgPSAobm9kZTogdHMuTm9kZSk6IHRzLk5vZGUgPT4ge1xuICAgIC8vIGltcG9ydCBmcm9tICc/J1xuICAgIGlmIChcbiAgICAgIHRzLmlzSW1wb3J0RGVjbGFyYXRpb24obm9kZSkgJiZcbiAgICAgIHRzLmlzU3RyaW5nTGl0ZXJhbExpa2Uobm9kZS5tb2R1bGVTcGVjaWZpZXIpICYmXG4gICAgICBub2RlLm1vZHVsZVNwZWNpZmllci50ZXh0XG4gICAgKSB7XG4gICAgICBjb25zdCBpbXBvcnRQYXRoOiBzdHJpbmcgPSBub2RlLm1vZHVsZVNwZWNpZmllci50ZXh0O1xuICAgICAgY29uc3QgcmV3cml0dGVuSW1wb3J0UGF0aDogc3RyaW5nID0gcmV3cml0ZUJ1bmRsZUltcG9ydCh7XG4gICAgICAgIGltcG9ydFBhdGgsXG4gICAgICB9KTtcblxuICAgICAgaWYgKGltcG9ydFBhdGggIT09IHJld3JpdHRlbkltcG9ydFBhdGgpIHtcbiAgICAgICAgcmV0dXJuIHRzLmZhY3RvcnkudXBkYXRlSW1wb3J0RGVjbGFyYXRpb24oXG4gICAgICAgICAgbm9kZSxcbiAgICAgICAgICBub2RlLmRlY29yYXRvcnMsXG4gICAgICAgICAgbm9kZS5tb2RpZmllcnMsXG4gICAgICAgICAgbm9kZS5pbXBvcnRDbGF1c2UsXG4gICAgICAgICAgdHMuZmFjdG9yeS5jcmVhdGVTdHJpbmdMaXRlcmFsKHJld3JpdHRlbkltcG9ydFBhdGgpLFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgICAvLyBpbXBvcnQoJz8nKVxuICAgIGVsc2UgaWYgKFxuICAgICAgdHMuaXNDYWxsRXhwcmVzc2lvbihub2RlKSAmJlxuICAgICAgbm9kZS5leHByZXNzaW9uLmtpbmQgPT09IHRzLlN5bnRheEtpbmQuSW1wb3J0S2V5d29yZCAmJlxuICAgICAgdHMuaXNTdHJpbmdMaXRlcmFsTGlrZShub2RlLmFyZ3VtZW50c1swXSlcbiAgICApIHtcbiAgICAgIGNvbnN0IGltcG9ydFBhdGg6IHN0cmluZyA9IChub2RlLmFyZ3VtZW50c1swXSBhcyB0cy5TdHJpbmdMaXRlcmFsTGlrZSlcbiAgICAgICAgLnRleHQ7XG4gICAgICBjb25zdCByZXdyaXR0ZW5JbXBvcnRQYXRoOiBzdHJpbmcgPSByZXdyaXRlQnVuZGxlSW1wb3J0KHtcbiAgICAgICAgaW1wb3J0UGF0aCxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoaW1wb3J0UGF0aCAhPT0gcmV3cml0dGVuSW1wb3J0UGF0aCkge1xuICAgICAgICByZXR1cm4gdHMuZmFjdG9yeS51cGRhdGVDYWxsRXhwcmVzc2lvbihcbiAgICAgICAgICBub2RlLFxuICAgICAgICAgIG5vZGUuZXhwcmVzc2lvbixcbiAgICAgICAgICBub2RlLnR5cGVBcmd1bWVudHMsXG4gICAgICAgICAgW1xuICAgICAgICAgICAgdHMuZmFjdG9yeS5jcmVhdGVTdHJpbmdMaXRlcmFsKHJld3JpdHRlbkltcG9ydFBhdGgpLFxuICAgICAgICAgICAgLi4ubm9kZS5hcmd1bWVudHMuc2xpY2UoMSksXG4gICAgICAgICAgXSxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gcmVxdWlyZS5yZXNvbHZlKCc/JylcbiAgICBlbHNlIGlmIChcbiAgICAgIHRzLmlzQ2FsbEV4cHJlc3Npb24obm9kZSkgJiZcbiAgICAgIHRzLmlzUHJvcGVydHlBY2Nlc3NFeHByZXNzaW9uKG5vZGUuZXhwcmVzc2lvbikgJiZcbiAgICAgIHRzLmlzSWRlbnRpZmllcihub2RlLmV4cHJlc3Npb24uZXhwcmVzc2lvbikgJiZcbiAgICAgIG5vZGUuZXhwcmVzc2lvbi5leHByZXNzaW9uLmVzY2FwZWRUZXh0ID09PSAncmVxdWlyZScgJiZcbiAgICAgIG5vZGUuZXhwcmVzc2lvbi5uYW1lLmVzY2FwZWRUZXh0ID09PSAncmVzb2x2ZScgJiZcbiAgICAgIHRzLmlzU3RyaW5nTGl0ZXJhbExpa2Uobm9kZS5hcmd1bWVudHNbMF0pXG4gICAgKSB7XG4gICAgICBjb25zdCBpbXBvcnRQYXRoOiBzdHJpbmcgPSAobm9kZS5hcmd1bWVudHNbMF0gYXMgdHMuU3RyaW5nTGl0ZXJhbExpa2UpXG4gICAgICAgIC50ZXh0O1xuICAgICAgY29uc3QgcmV3cml0dGVuSW1wb3J0UGF0aDogc3RyaW5nID0gcmV3cml0ZUJ1bmRsZUltcG9ydCh7XG4gICAgICAgIGltcG9ydFBhdGgsXG4gICAgICB9KTtcblxuICAgICAgaWYgKGltcG9ydFBhdGggIT09IHJld3JpdHRlbkltcG9ydFBhdGgpIHtcbiAgICAgICAgcmV0dXJuIHRzLmZhY3RvcnkudXBkYXRlQ2FsbEV4cHJlc3Npb24oXG4gICAgICAgICAgbm9kZSxcbiAgICAgICAgICBub2RlLmV4cHJlc3Npb24sXG4gICAgICAgICAgbm9kZS50eXBlQXJndW1lbnRzLFxuICAgICAgICAgIFtcbiAgICAgICAgICAgIHRzLmZhY3RvcnkuY3JlYXRlU3RyaW5nTGl0ZXJhbChyZXdyaXR0ZW5JbXBvcnRQYXRoKSxcbiAgICAgICAgICAgIC4uLm5vZGUuYXJndW1lbnRzLnNsaWNlKDEpLFxuICAgICAgICAgIF0sXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICAgIC8vIHJlcXVpcmUoJz8nKVxuICAgIGVsc2UgaWYgKFxuICAgICAgdHMuaXNDYWxsRXhwcmVzc2lvbihub2RlKSAmJlxuICAgICAgdHMuaXNJZGVudGlmaWVyKG5vZGUuZXhwcmVzc2lvbikgJiZcbiAgICAgIG5vZGUuZXhwcmVzc2lvbi5lc2NhcGVkVGV4dCA9PT0gJ3JlcXVpcmUnICYmXG4gICAgICB0cy5pc1N0cmluZ0xpdGVyYWxMaWtlKG5vZGUuYXJndW1lbnRzWzBdKVxuICAgICkge1xuICAgICAgY29uc3QgaW1wb3J0UGF0aDogc3RyaW5nID0gKG5vZGUuYXJndW1lbnRzWzBdIGFzIHRzLlN0cmluZ0xpdGVyYWxMaWtlKVxuICAgICAgICAudGV4dDtcbiAgICAgIGNvbnN0IHJld3JpdHRlbkltcG9ydFBhdGg6IHN0cmluZyA9IHJld3JpdGVCdW5kbGVJbXBvcnQoe1xuICAgICAgICBpbXBvcnRQYXRoLFxuICAgICAgfSk7XG5cbiAgICAgIGlmIChpbXBvcnRQYXRoICE9PSByZXdyaXR0ZW5JbXBvcnRQYXRoKSB7XG4gICAgICAgIHJldHVybiB0cy5mYWN0b3J5LnVwZGF0ZUNhbGxFeHByZXNzaW9uKFxuICAgICAgICAgIG5vZGUsXG4gICAgICAgICAgbm9kZS5leHByZXNzaW9uLFxuICAgICAgICAgIG5vZGUudHlwZUFyZ3VtZW50cyxcbiAgICAgICAgICBbXG4gICAgICAgICAgICB0cy5mYWN0b3J5LmNyZWF0ZVN0cmluZ0xpdGVyYWwocmV3cml0dGVuSW1wb3J0UGF0aCksXG4gICAgICAgICAgICAuLi5ub2RlLmFyZ3VtZW50cy5zbGljZSgxKSxcbiAgICAgICAgICBdLFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB0cy52aXNpdEVhY2hDaGlsZChub2RlLCB2aXNpdG9yLCBjdHgpO1xuICB9O1xuXG4gIHJldHVybiB2aXNpdG9yO1xufVxuXG5leHBvcnQgY29uc3QgYnVuZGxlSW1wb3J0UmV3cml0ZSA9XG4gIChjb25maWc6IENvbmZpZ3VyYXRpb24pOiB0cy5UcmFuc2Zvcm1lckZhY3Rvcnk8dHMuU291cmNlRmlsZT4gPT5cbiAgKGN0eDogdHMuVHJhbnNmb3JtYXRpb25Db250ZXh0KSA9PlxuICAobm9kZTogdHMuU291cmNlRmlsZSkgPT4ge1xuICAgIHJldHVybiB0cy52aXNpdE5vZGUobm9kZSwgY3JlYXRlVmlzaXRvcih7IC4uLmNvbmZpZywgY3R4IH0pKTtcbiAgfTtcbiJdfQ==