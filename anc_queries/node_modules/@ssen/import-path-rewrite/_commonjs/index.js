"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.importPathRewrite = void 0;
const rewrite_src_path_1 = require("@ssen/rewrite-src-path");
const typescript_1 = __importDefault(require("typescript"));
function createVisitor({ src, ctx, fileName, }) {
    const visitor = (node) => {
        // import from '?'
        if (typescript_1.default.isImportDeclaration(node) &&
            typescript_1.default.isStringLiteralLike(node.moduleSpecifier) &&
            node.moduleSpecifier.text) {
            const importPath = node.moduleSpecifier.text;
            const rewrittenImportPath = rewrite_src_path_1.rewriteSrcPath({
                importPath,
                filePath: fileName || node.getSourceFile().fileName,
                rootDir: src,
            });
            if (importPath !== rewrittenImportPath) {
                return typescript_1.default.factory.updateImportDeclaration(node, node.decorators, node.modifiers, node.importClause, typescript_1.default.factory.createStringLiteral(rewrittenImportPath));
            }
        }
        // import('?')
        else if (typescript_1.default.isCallExpression(node) &&
            node.expression.kind === typescript_1.default.SyntaxKind.ImportKeyword &&
            typescript_1.default.isStringLiteralLike(node.arguments[0])) {
            const importPath = node.arguments[0]
                .text;
            const rewrittenImportPath = rewrite_src_path_1.rewriteSrcPath({
                importPath,
                filePath: fileName || node.getSourceFile().fileName,
                rootDir: src,
            });
            if (importPath !== rewrittenImportPath) {
                return typescript_1.default.factory.updateCallExpression(node, node.expression, node.typeArguments, [
                    typescript_1.default.factory.createStringLiteral(rewrittenImportPath),
                    ...node.arguments.slice(1),
                ]);
            }
        }
        // require.resolve('?')
        else if (typescript_1.default.isCallExpression(node) &&
            typescript_1.default.isPropertyAccessExpression(node.expression) &&
            typescript_1.default.isIdentifier(node.expression.expression) &&
            node.expression.expression.escapedText === 'require' &&
            node.expression.name.escapedText === 'resolve' &&
            typescript_1.default.isStringLiteralLike(node.arguments[0])) {
            const importPath = node.arguments[0]
                .text;
            const rewrittenImportPath = rewrite_src_path_1.rewriteSrcPath({
                importPath,
                filePath: fileName || node.getSourceFile().fileName,
                rootDir: src,
            });
            if (importPath !== rewrittenImportPath) {
                return typescript_1.default.factory.updateCallExpression(node, node.expression, node.typeArguments, [
                    typescript_1.default.factory.createStringLiteral(rewrittenImportPath),
                    ...node.arguments.slice(1),
                ]);
            }
        }
        // require('?')
        else if (typescript_1.default.isCallExpression(node) &&
            typescript_1.default.isIdentifier(node.expression) &&
            node.expression.escapedText === 'require' &&
            typescript_1.default.isStringLiteralLike(node.arguments[0])) {
            const importPath = node.arguments[0]
                .text;
            const rewrittenImportPath = rewrite_src_path_1.rewriteSrcPath({
                importPath,
                filePath: fileName || node.getSourceFile().fileName,
                rootDir: src,
            });
            if (importPath !== rewrittenImportPath) {
                return typescript_1.default.factory.updateCallExpression(node, node.expression, node.typeArguments, [
                    typescript_1.default.factory.createStringLiteral(rewrittenImportPath),
                    ...node.arguments.slice(1),
                ]);
            }
        }
        return typescript_1.default.visitEachChild(node, visitor, ctx);
    };
    return visitor;
}
const importPathRewrite = (config) => (ctx) => (node) => {
    return typescript_1.default.visitNode(node, createVisitor({ ...config, ctx }));
};
exports.importPathRewrite = importPathRewrite;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvQHNzZW4vaW1wb3J0LXBhdGgtcmV3cml0ZS9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSw2REFBd0Q7QUFDeEQsNERBQTRCO0FBa0I1QixTQUFTLGFBQWEsQ0FBQyxFQUNyQixHQUFHLEVBQ0gsR0FBRyxFQUNILFFBQVEsR0FDMEM7SUFDbEQsTUFBTSxPQUFPLEdBQWUsQ0FBQyxJQUFhLEVBQVcsRUFBRTtRQUNyRCxrQkFBa0I7UUFDbEIsSUFDRSxvQkFBRSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQztZQUM1QixvQkFBRSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxlQUFlLENBQUM7WUFDNUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLEVBQ3pCO1lBQ0EsTUFBTSxVQUFVLEdBQVcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUM7WUFDckQsTUFBTSxtQkFBbUIsR0FBVyxpQ0FBYyxDQUFDO2dCQUNqRCxVQUFVO2dCQUNWLFFBQVEsRUFBRSxRQUFRLElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDLFFBQVE7Z0JBQ25ELE9BQU8sRUFBRSxHQUFHO2FBQ2IsQ0FBQyxDQUFDO1lBRUgsSUFBSSxVQUFVLEtBQUssbUJBQW1CLEVBQUU7Z0JBQ3RDLE9BQU8sb0JBQUUsQ0FBQyxPQUFPLENBQUMsdUJBQXVCLENBQ3ZDLElBQUksRUFDSixJQUFJLENBQUMsVUFBVSxFQUNmLElBQUksQ0FBQyxTQUFTLEVBQ2QsSUFBSSxDQUFDLFlBQVksRUFDakIsb0JBQUUsQ0FBQyxPQUFPLENBQUMsbUJBQW1CLENBQUMsbUJBQW1CLENBQUMsQ0FDcEQsQ0FBQzthQUNIO1NBQ0Y7UUFDRCxjQUFjO2FBQ1QsSUFDSCxvQkFBRSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQztZQUN6QixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksS0FB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QkFBbUIsRUFBRTtnQkFDdEMsT0FBTyxvQkFBRSxDQUFDLE9BQU8sQ0FBQyxvQkFBb0IsQ0FDcEMsSUFBSSxFQUNKLElBQUksQ0FBQyxVQUFVLEVBQ2YsSUFBSSxDQUFDLGFBQWEsRUFDbEI7b0JBQ0Usb0JBQUUsQ0FBQyxPQUFPLENBQUMsbUJBQW1CLENBQUMsbUJBQW1CLENBQUM7b0JBQ25ELEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO2lCQUMzQixDQUNGLENBQUM7YUFDSDtTQUNGO1FBRUQsT0FBTyxvQkFBRSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQy9DLENBQUMsQ0FBQztJQUVGLE9BQU8sT0FBTyxDQUFDO0FBQ2pCLENBQUM7QUFFTSxNQUFNLGlCQUFpQixHQUM1QixDQUFDLE1BQXFCLEVBQXdDLEVBQUUsQ0FDaEUsQ0FBQyxHQUE2QixFQUFFLEVBQUUsQ0FDbEMsQ0FBQyxJQUFtQixFQUFFLEVBQUU7SUFDdEIsT0FBTyxvQkFBRSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsYUFBYSxDQUFDLEVBQUUsR0FBRyxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBQy9ELENBQUMsQ0FBQztBQUxTLFFBQUEsaUJBQWlCLHFCQUsxQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHJld3JpdGVTcmNQYXRoIH0gZnJvbSAnQHNzZW4vcmV3cml0ZS1zcmMtcGF0aCc7XG5pbXBvcnQgdHMgZnJvbSAndHlwZXNjcmlwdCc7XG5cbmludGVyZmFjZSBDb25maWd1cmF0aW9uIHtcbiAgLyoqXG4gICAqIHNvdXJjZSByb290XG4gICAqXG4gICAqIC9wcm9qZWN0L3Jvb3Qvc3JjXG4gICAqL1xuICBzcmM6IHN0cmluZztcblxuICAvKipcbiAgICogZmlsZSBwYXRoXG4gICAqXG4gICAqIC9wcm9qZWN0L3Jvb3Qvc3JjL3BhdGgvZmlsZS50c1xuICAgKi9cbiAgZmlsZU5hbWU/OiBzdHJpbmc7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZVZpc2l0b3Ioe1xuICBzcmMsXG4gIGN0eCxcbiAgZmlsZU5hbWUsXG59OiBDb25maWd1cmF0aW9uICYgeyBjdHg6IHRzLlRyYW5zZm9ybWF0aW9uQ29udGV4dCB9KTogdHMuVmlzaXRvciB7XG4gIGNvbnN0IHZpc2l0b3I6IHRzLlZpc2l0b3IgPSAobm9kZTogdHMuTm9kZSk6IHRzLk5vZGUgPT4ge1xuICAgIC8vIGltcG9ydCBmcm9tICc/J1xuICAgIGlmIChcbiAgICAgIHRzLmlzSW1wb3J0RGVjbGFyYXRpb24obm9kZSkgJiZcbiAgICAgIHRzLmlzU3RyaW5nTGl0ZXJhbExpa2Uobm9kZS5tb2R1bGVTcGVjaWZpZXIpICYmXG4gICAgICBub2RlLm1vZHVsZVNwZWNpZmllci50ZXh0XG4gICAgKSB7XG4gICAgICBjb25zdCBpbXBvcnRQYXRoOiBzdHJpbmcgPSBub2RlLm1vZHVsZVNwZWNpZmllci50ZXh0O1xuICAgICAgY29uc3QgcmV3cml0dGVuSW1wb3J0UGF0aDogc3RyaW5nID0gcmV3cml0ZVNyY1BhdGgoe1xuICAgICAgICBpbXBvcnRQYXRoLFxuICAgICAgICBmaWxlUGF0aDogZmlsZU5hbWUgfHwgbm9kZS5nZXRTb3VyY2VGaWxlKCkuZmlsZU5hbWUsXG4gICAgICAgIHJvb3REaXI6IHNyYyxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoaW1wb3J0UGF0aCAhPT0gcmV3cml0dGVuSW1wb3J0UGF0aCkge1xuICAgICAgICByZXR1cm4gdHMuZmFjdG9yeS51cGRhdGVJbXBvcnREZWNsYXJhdGlvbihcbiAgICAgICAgICBub2RlLFxuICAgICAgICAgIG5vZGUuZGVjb3JhdG9ycyxcbiAgICAgICAgICBub2RlLm1vZGlmaWVycyxcbiAgICAgICAgICBub2RlLmltcG9ydENsYXVzZSxcbiAgICAgICAgICB0cy5mYWN0b3J5LmNyZWF0ZVN0cmluZ0xpdGVyYWwocmV3cml0dGVuSW1wb3J0UGF0aCksXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICAgIC8vIGltcG9ydCgnPycpXG4gICAgZWxzZSBpZiAoXG4gICAgICB0cy5pc0NhbGxFeHByZXNzaW9uKG5vZGUpICYmXG4gICAgICBub2RlLmV4cHJlc3Npb24ua2luZCA9PT0gdHMuU3ludGF4S2luZC5JbXBvcnRLZXl3b3JkICYmXG4gICAgICB0cy5pc1N0cmluZ0xpdGVyYWxMaWtlKG5vZGUuYXJndW1lbnRzWzBdKVxuICAgICkge1xuICAgICAgY29uc3QgaW1wb3J0UGF0aDogc3RyaW5nID0gKG5vZGUuYXJndW1lbnRzWzBdIGFzIHRzLlN0cmluZ0xpdGVyYWxMaWtlKVxuICAgICAgICAudGV4dDtcbiAgICAgIGNvbnN0IHJld3JpdHRlbkltcG9ydFBhdGg6IHN0cmluZyA9IHJld3JpdGVTcmNQYXRoKHtcbiAgICAgICAgaW1wb3J0UGF0aCxcbiAgICAgICAgZmlsZVBhdGg6IGZpbGVOYW1lIHx8IG5vZGUuZ2V0U291cmNlRmlsZSgpLmZpbGVOYW1lLFxuICAgICAgICByb290RGlyOiBzcmMsXG4gICAgICB9KTtcblxuICAgICAgaWYgKGltcG9ydFBhdGggIT09IHJld3JpdHRlbkltcG9ydFBhdGgpIHtcbiAgICAgICAgcmV0dXJuIHRzLmZhY3RvcnkudXBkYXRlQ2FsbEV4cHJlc3Npb24oXG4gICAgICAgICAgbm9kZSxcbiAgICAgICAgICBub2RlLmV4cHJlc3Npb24sXG4gICAgICAgICAgbm9kZS50eXBlQXJndW1lbnRzLFxuICAgICAgICAgIFtcbiAgICAgICAgICAgIHRzLmZhY3RvcnkuY3JlYXRlU3RyaW5nTGl0ZXJhbChyZXdyaXR0ZW5JbXBvcnRQYXRoKSxcbiAgICAgICAgICAgIC4uLm5vZGUuYXJndW1lbnRzLnNsaWNlKDEpLFxuICAgICAgICAgIF0sXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICAgIC8vIHJlcXVpcmUucmVzb2x2ZSgnPycpXG4gICAgZWxzZSBpZiAoXG4gICAgICB0cy5pc0NhbGxFeHByZXNzaW9uKG5vZGUpICYmXG4gICAgICB0cy5pc1Byb3BlcnR5QWNjZXNzRXhwcmVzc2lvbihub2RlLmV4cHJlc3Npb24pICYmXG4gICAgICB0cy5pc0lkZW50aWZpZXIobm9kZS5leHByZXNzaW9uLmV4cHJlc3Npb24pICYmXG4gICAgICBub2RlLmV4cHJlc3Npb24uZXhwcmVzc2lvbi5lc2NhcGVkVGV4dCA9PT0gJ3JlcXVpcmUnICYmXG4gICAgICBub2RlLmV4cHJlc3Npb24ubmFtZS5lc2NhcGVkVGV4dCA9PT0gJ3Jlc29sdmUnICYmXG4gICAgICB0cy5pc1N0cmluZ0xpdGVyYWxMaWtlKG5vZGUuYXJndW1lbnRzWzBdKVxuICAgICkge1xuICAgICAgY29uc3QgaW1wb3J0UGF0aDogc3RyaW5nID0gKG5vZGUuYXJndW1lbnRzWzBdIGFzIHRzLlN0cmluZ0xpdGVyYWxMaWtlKVxuICAgICAgICAudGV4dDtcbiAgICAgIGNvbnN0IHJld3JpdHRlbkltcG9ydFBhdGg6IHN0cmluZyA9IHJld3JpdGVTcmNQYXRoKHtcbiAgICAgICAgaW1wb3J0UGF0aCxcbiAgICAgICAgZmlsZVBhdGg6IGZpbGVOYW1lIHx8IG5vZGUuZ2V0U291cmNlRmlsZSgpLmZpbGVOYW1lLFxuICAgICAgICByb290RGlyOiBzcmMsXG4gICAgICB9KTtcblxuICAgICAgaWYgKGltcG9ydFBhdGggIT09IHJld3JpdHRlbkltcG9ydFBhdGgpIHtcbiAgICAgICAgcmV0dXJuIHRzLmZhY3RvcnkudXBkYXRlQ2FsbEV4cHJlc3Npb24oXG4gICAgICAgICAgbm9kZSxcbiAgICAgICAgICBub2RlLmV4cHJlc3Npb24sXG4gICAgICAgICAgbm9kZS50eXBlQXJndW1lbnRzLFxuICAgICAgICAgIFtcbiAgICAgICAgICAgIHRzLmZhY3RvcnkuY3JlYXRlU3RyaW5nTGl0ZXJhbChyZXdyaXR0ZW5JbXBvcnRQYXRoKSxcbiAgICAgICAgICAgIC4uLm5vZGUuYXJndW1lbnRzLnNsaWNlKDEpLFxuICAgICAgICAgIF0sXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICAgIC8vIHJlcXVpcmUoJz8nKVxuICAgIGVsc2UgaWYgKFxuICAgICAgdHMuaXNDYWxsRXhwcmVzc2lvbihub2RlKSAmJlxuICAgICAgdHMuaXNJZGVudGlmaWVyKG5vZGUuZXhwcmVzc2lvbikgJiZcbiAgICAgIG5vZGUuZXhwcmVzc2lvbi5lc2NhcGVkVGV4dCA9PT0gJ3JlcXVpcmUnICYmXG4gICAgICB0cy5pc1N0cmluZ0xpdGVyYWxMaWtlKG5vZGUuYXJndW1lbnRzWzBdKVxuICAgICkge1xuICAgICAgY29uc3QgaW1wb3J0UGF0aDogc3RyaW5nID0gKG5vZGUuYXJndW1lbnRzWzBdIGFzIHRzLlN0cmluZ0xpdGVyYWxMaWtlKVxuICAgICAgICAudGV4dDtcbiAgICAgIGNvbnN0IHJld3JpdHRlbkltcG9ydFBhdGg6IHN0cmluZyA9IHJld3JpdGVTcmNQYXRoKHtcbiAgICAgICAgaW1wb3J0UGF0aCxcbiAgICAgICAgZmlsZVBhdGg6IGZpbGVOYW1lIHx8IG5vZGUuZ2V0U291cmNlRmlsZSgpLmZpbGVOYW1lLFxuICAgICAgICByb290RGlyOiBzcmMsXG4gICAgICB9KTtcblxuICAgICAgaWYgKGltcG9ydFBhdGggIT09IHJld3JpdHRlbkltcG9ydFBhdGgpIHtcbiAgICAgICAgcmV0dXJuIHRzLmZhY3RvcnkudXBkYXRlQ2FsbEV4cHJlc3Npb24oXG4gICAgICAgICAgbm9kZSxcbiAgICAgICAgICBub2RlLmV4cHJlc3Npb24sXG4gICAgICAgICAgbm9kZS50eXBlQXJndW1lbnRzLFxuICAgICAgICAgIFtcbiAgICAgICAgICAgIHRzLmZhY3RvcnkuY3JlYXRlU3RyaW5nTGl0ZXJhbChyZXdyaXR0ZW5JbXBvcnRQYXRoKSxcbiAgICAgICAgICAgIC4uLm5vZGUuYXJndW1lbnRzLnNsaWNlKDEpLFxuICAgICAgICAgIF0sXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHRzLnZpc2l0RWFjaENoaWxkKG5vZGUsIHZpc2l0b3IsIGN0eCk7XG4gIH07XG5cbiAgcmV0dXJuIHZpc2l0b3I7XG59XG5cbmV4cG9ydCBjb25zdCBpbXBvcnRQYXRoUmV3cml0ZSA9XG4gIChjb25maWc6IENvbmZpZ3VyYXRpb24pOiB0cy5UcmFuc2Zvcm1lckZhY3Rvcnk8dHMuU291cmNlRmlsZT4gPT5cbiAgKGN0eDogdHMuVHJhbnNmb3JtYXRpb25Db250ZXh0KSA9PlxuICAobm9kZTogdHMuU291cmNlRmlsZSkgPT4ge1xuICAgIHJldHVybiB0cy52aXNpdE5vZGUobm9kZSwgY3JlYXRlVmlzaXRvcih7IC4uLmNvbmZpZywgY3R4IH0pKTtcbiAgfTtcbiJdfQ==