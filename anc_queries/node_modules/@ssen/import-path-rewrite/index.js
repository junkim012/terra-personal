import { rewriteSrcPath } from '@ssen/rewrite-src-path';
import ts from 'typescript';
function createVisitor({ src, ctx, fileName, }) {
    const visitor = (node) => {
        // import from '?'
        if (ts.isImportDeclaration(node) &&
            ts.isStringLiteralLike(node.moduleSpecifier) &&
            node.moduleSpecifier.text) {
            const importPath = node.moduleSpecifier.text;
            const rewrittenImportPath = rewriteSrcPath({
                importPath,
                filePath: fileName || node.getSourceFile().fileName,
                rootDir: src,
            });
            if (importPath !== rewrittenImportPath) {
                return ts.factory.updateImportDeclaration(node, node.decorators, node.modifiers, node.importClause, ts.factory.createStringLiteral(rewrittenImportPath));
            }
        }
        // import('?')
        else if (ts.isCallExpression(node) &&
            node.expression.kind === ts.SyntaxKind.ImportKeyword &&
            ts.isStringLiteralLike(node.arguments[0])) {
            const importPath = node.arguments[0]
                .text;
            const rewrittenImportPath = rewriteSrcPath({
                importPath,
                filePath: fileName || node.getSourceFile().fileName,
                rootDir: src,
            });
            if (importPath !== rewrittenImportPath) {
                return ts.factory.updateCallExpression(node, node.expression, node.typeArguments, [
                    ts.factory.createStringLiteral(rewrittenImportPath),
                    ...node.arguments.slice(1),
                ]);
            }
        }
        // require.resolve('?')
        else if (ts.isCallExpression(node) &&
            ts.isPropertyAccessExpression(node.expression) &&
            ts.isIdentifier(node.expression.expression) &&
            node.expression.expression.escapedText === 'require' &&
            node.expression.name.escapedText === 'resolve' &&
            ts.isStringLiteralLike(node.arguments[0])) {
            const importPath = node.arguments[0]
                .text;
            const rewrittenImportPath = rewriteSrcPath({
                importPath,
                filePath: fileName || node.getSourceFile().fileName,
                rootDir: src,
            });
            if (importPath !== rewrittenImportPath) {
                return ts.factory.updateCallExpression(node, node.expression, node.typeArguments, [
                    ts.factory.createStringLiteral(rewrittenImportPath),
                    ...node.arguments.slice(1),
                ]);
            }
        }
        // require('?')
        else if (ts.isCallExpression(node) &&
            ts.isIdentifier(node.expression) &&
            node.expression.escapedText === 'require' &&
            ts.isStringLiteralLike(node.arguments[0])) {
            const importPath = node.arguments[0]
                .text;
            const rewrittenImportPath = rewriteSrcPath({
                importPath,
                filePath: fileName || node.getSourceFile().fileName,
                rootDir: src,
            });
            if (importPath !== rewrittenImportPath) {
                return ts.factory.updateCallExpression(node, node.expression, node.typeArguments, [
                    ts.factory.createStringLiteral(rewrittenImportPath),
                    ...node.arguments.slice(1),
                ]);
            }
        }
        return ts.visitEachChild(node, visitor, ctx);
    };
    return visitor;
}
export const importPathRewrite = (config) => (ctx) => (node) => {
    return ts.visitNode(node, createVisitor({ ...config, ctx }));
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvQHNzZW4vaW1wb3J0LXBhdGgtcmV3cml0ZS9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDeEQsT0FBTyxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBa0I1QixTQUFTLGFBQWEsQ0FBQyxFQUNyQixHQUFHLEVBQ0gsR0FBRyxFQUNILFFBQVEsR0FDMEM7SUFDbEQsTUFBTSxPQUFPLEdBQWUsQ0FBQyxJQUFhLEVBQVcsRUFBRTtRQUNyRCxrQkFBa0I7UUFDbEIsSUFDRSxFQUFFLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDO1lBQzVCLEVBQUUsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDO1lBQzVDLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxFQUN6QjtZQUNBLE1BQU0sVUFBVSxHQUFXLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDO1lBQ3JELE1BQU0sbUJBQW1CLEdBQVcsY0FBYyxDQUFDO2dCQUNqRCxVQUFVO2dCQUNWLFFBQVEsRUFBRSxRQUFRLElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDLFFBQVE7Z0JBQ25ELE9BQU8sRUFBRSxHQUFHO2FBQ2IsQ0FBQyxDQUFDO1lBRUgsSUFBSSxVQUFVLEtBQUssbUJBQW1CLEVBQUU7Z0JBQ3RDLE9BQU8sRUFBRSxDQUFDLE9BQU8sQ0FBQyx1QkFBdUIsQ0FDdkMsSUFBSSxFQUNKLElBQUksQ0FBQyxVQUFVLEVBQ2YsSUFBSSxDQUFDLFNBQVMsRUFDZCxJQUFJLENBQUMsWUFBWSxFQUNqQixFQUFFLENBQUMsT0FBTyxDQUFDLG1CQUFtQixDQUFDLG1CQUFtQixDQUFDLENBQ3BELENBQUM7YUFDSDtTQUNGO1FBQ0QsY0FBYzthQUNULElBQ0gsRUFBRSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQztZ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LElBQUksVUFBVSxLQUFLLG1CQUFtQixFQUFFO2dCQUN0QyxPQUFPLEVBQUUsQ0FBQyxPQUFPLENBQUMsb0JBQW9CLENBQ3BDLElBQUksRUFDSixJQUFJLENBQUMsVUFBVSxFQUNmLElBQUksQ0FBQyxhQUFhLEVBQ2xCO29CQUNFLEVBQUUsQ0FBQyxPQUFPLENBQUMsbUJBQW1CLENBQUMsbUJBQW1CLENBQUM7b0JBQ25ELEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO2lCQUMzQixDQUNGLENBQUM7YUFDSDtTQUNGO1FBRUQsT0FBTyxFQUFFLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDL0MsQ0FBQyxDQUFDO0lBRUYsT0FBTyxPQUFPLENBQUM7QUFDakIsQ0FBQztBQUVELE1BQU0sQ0FBQyxNQUFNLGlCQUFpQixHQUM1QixDQUFDLE1BQXFCLEVBQXdDLEVBQUUsQ0FDaEUsQ0FBQyxHQUE2QixFQUFFLEVBQUUsQ0FDbEMsQ0FBQyxJQUFtQixFQUFFLEVBQUU7SUFDdEIsT0FBTyxFQUFFLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxhQUFhLENBQUMsRUFBRSxHQUFHLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFDL0QsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcmV3cml0ZVNyY1BhdGggfSBmcm9tICdAc3Nlbi9yZXdyaXRlLXNyYy1wYXRoJztcbmltcG9ydCB0cyBmcm9tICd0eXBlc2NyaXB0JztcblxuaW50ZXJmYWNlIENvbmZpZ3VyYXRpb24ge1xuICAvKipcbiAgICogc291cmNlIHJvb3RcbiAgICpcbiAgICogL3Byb2plY3Qvcm9vdC9zcmNcbiAgICovXG4gIHNyYzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBmaWxlIHBhdGhcbiAgICpcbiAgICogL3Byb2plY3Qvcm9vdC9zcmMvcGF0aC9maWxlLnRzXG4gICAqL1xuICBmaWxlTmFtZT86IHN0cmluZztcbn1cblxuZnVuY3Rpb24gY3JlYXRlVmlzaXRvcih7XG4gIHNyYyxcbiAgY3R4LFxuICBmaWxlTmFtZSxcbn06IENvbmZpZ3VyYXRpb24gJiB7IGN0eDogdHMuVHJhbnNmb3JtYXRpb25Db250ZXh0IH0pOiB0cy5WaXNpdG9yIHtcbiAgY29uc3QgdmlzaXRvcjogdHMuVmlzaXRvciA9IChub2RlOiB0cy5Ob2RlKTogdHMuTm9kZSA9PiB7XG4gICAgLy8gaW1wb3J0IGZyb20gJz8nXG4gICAgaWYgKFxuICAgICAgdHMuaXNJbXBvcnREZWNsYXJhdGlvbihub2RlKSAmJlxuICAgICAgdHMuaXNTdHJpbmdMaXRlcmFsTGlrZShub2RlLm1vZHVsZVNwZWNpZmllcikgJiZcbiAgICAgIG5vZGUubW9kdWxlU3BlY2lmaWVyLnRleHRcbiAgICApIHtcbiAgICAgIGNvbnN0IGltcG9ydFBhdGg6IHN0cmluZyA9IG5vZGUubW9kdWxlU3BlY2lmaWVyLnRleHQ7XG4gICAgICBjb25zdCByZXdyaXR0ZW5JbXBvcnRQYXRoOiBzdHJpbmcgPSByZXdyaXRlU3JjUGF0aCh7XG4gICAgICAgIGltcG9ydFBhdGgsXG4gICAgICAgIGZpbGVQYXRoOiBmaWxlTmFtZSB8fCBub2RlLmdldFNvdXJjZUZpbGUoKS5maWxlTmFtZSxcbiAgICAgICAgcm9vdERpcjogc3JjLFxuICAgICAgfSk7XG5cbiAgICAgIGlmIChpbXBvcnRQYXRoICE9PSByZXdyaXR0ZW5JbXBvcnRQYXRoKSB7XG4gICAgICAgIHJldHVybiB0cy5mYWN0b3J5LnVwZGF0ZUltcG9ydERlY2xhcmF0aW9uKFxuICAgICAgICAgIG5vZGUsXG4gICAgICAgICAgbm9kZS5kZWNvcmF0b3JzLFxuICAgICAgICAgIG5vZGUubW9kaWZpZXJzLFxuICAgICAgICAgIG5vZGUuaW1wb3J0Q2xhdXNlLFxuICAgICAgICAgIHRzLmZhY3RvcnkuY3JlYXRlU3RyaW5nTGl0ZXJhbChyZXdyaXR0ZW5JbXBvcnRQYXRoKSxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gaW1wb3J0KCc/JylcbiAgICBlbHNlIGlmIChcbiAgICAgIHRzLmlzQ2FsbEV4cHJlc3Npb24obm9kZSkgJiZcbiAgICAgIG5vZGUuZXhwcmVzc2lvbi5raW5kID09PSB0cy5TeW50YXhLaW5kLkltcG9ydEtleXdvcmQgJiZcbiAgICAgIHRzLmlzU3RyaW5nTGl0ZXJhbExpa2Uobm9kZS5hcmd1bWVudHNbMF0pXG4gICAgKSB7XG4gICAgICBjb25zdCBpbXBvcnRQYXRoOiBzdHJpbmcgPSAobm9kZS5hcmd1bWVudHNbMF0gYXMgdHMuU3RyaW5nTGl0ZXJhbExpa2UpXG4gICAgICAgIC50ZXh0O1xuICAgICAgY29uc3QgcmV3cml0dGVuSW1wb3J0UGF0aDogc3RyaW5nID0gcmV3cml0ZVNyY1BhdGgoe1xuICAgICAgICBpbXBvcnRQYXRoLFxuICAgICAgICBmaWxlUGF0aDogZmlsZU5hbWUgfHwgbm9kZS5nZXRTb3VyY2VGaWxlKCkuZmlsZU5hbWUsXG4gICAgICAgIHJvb3REaXI6IHNyYyxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoaW1wb3J0UGF0aCAhPT0gcmV3cml0dGVuSW1wb3J0UGF0aCkge1xuICAgICAgICByZXR1cm4gdHMuZmFjdG9yeS51cGRhdGVDYWxsRXhwcmVzc2lvbihcbiAgICAgICAgICBub2RlLFxuICAgICAgICAgIG5vZGUuZXhwcmVzc2lvbixcbiAgICAgICAgICBub2RlLnR5cGVBcmd1bWVudHMsXG4gICAgICAgICAgW1xuICAgICAgICAgICAgdHMuZmFjdG9yeS5jcmVhdGVTdHJpbmdMaXRlcmFsKHJld3JpdHRlbkltcG9ydFBhdGgpLFxuICAgICAgICAgICAgLi4ubm9kZS5hcmd1bWVudHMuc2xpY2UoMSksXG4gICAgICAgICAgXSxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gcmVxdWlyZS5yZXNvbHZlKCc/JylcbiAgICBlbHNlIGlmIChcbiAgICAgIHRzLmlzQ2FsbEV4cHJlc3Npb24obm9kZSkgJiZcbiAgICAgIHRzLmlzUHJvcGVydHlBY2Nlc3NFeHByZXNzaW9uKG5vZGUuZXhwcmVzc2lvbikgJiZcbiAgICAgIHRzLmlzSWRlbnRpZmllcihub2RlLmV4cHJlc3Npb24uZXhwcmVzc2lvbikgJiZcbiAgICAgIG5vZGUuZXhwcmVzc2lvbi5leHByZXNzaW9uLmVzY2FwZWRUZXh0ID09PSAncmVxdWlyZScgJiZcbiAgICAgIG5vZGUuZXhwcmVzc2lvbi5uYW1lLmVzY2FwZWRUZXh0ID09PSAncmVzb2x2ZScgJiZcbiAgICAgIHRzLmlzU3RyaW5nTGl0ZXJhbExpa2Uobm9kZS5hcmd1bWVudHNbMF0pXG4gICAgKSB7XG4gICAgICBjb25zdCBpbXBvcnRQYXRoOiBzdHJpbmcgPSAobm9kZS5hcmd1bWVudHNbMF0gYXMgdHMuU3RyaW5nTGl0ZXJhbExpa2UpXG4gICAgICAgIC50ZXh0O1xuICAgICAgY29uc3QgcmV3cml0dGVuSW1wb3J0UGF0aDogc3RyaW5nID0gcmV3cml0ZVNyY1BhdGgoe1xuICAgICAgICBpbXBvcnRQYXRoLFxuICAgICAgICBmaWxlUGF0aDogZmlsZU5hbWUgfHwgbm9kZS5nZXRTb3VyY2VGaWxlKCkuZmlsZU5hbWUsXG4gICAgICAgIHJvb3REaXI6IHNyYyxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoaW1wb3J0UGF0aCAhPT0gcmV3cml0dGVuSW1wb3J0UGF0aCkge1xuICAgICAgICByZXR1cm4gdHMuZmFjdG9yeS51cGRhdGVDYWxsRXhwcmVzc2lvbihcbiAgICAgICAgICBub2RlLFxuICAgICAgICAgIG5vZGUuZXhwcmVzc2lvbixcbiAgICAgICAgICBub2RlLnR5cGVBcmd1bWVudHMsXG4gICAgICAgICAgW1xuICAgICAgICAgICAgdHMuZmFjdG9yeS5jcmVhdGVTdHJpbmdMaXRlcmFsKHJld3JpdHRlbkltcG9ydFBhdGgpLFxuICAgICAgICAgICAgLi4ubm9kZS5hcmd1bWVudHMuc2xpY2UoMSksXG4gICAgICAgICAgXSxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gcmVxdWlyZSgnPycpXG4gICAgZWxzZSBpZiAoXG4gICAgICB0cy5pc0NhbGxFeHByZXNzaW9uKG5vZGUpICYmXG4gICAgICB0cy5pc0lkZW50aWZpZXIobm9kZS5leHByZXNzaW9uKSAmJlxuICAgICAgbm9kZS5leHByZXNzaW9uLmVzY2FwZWRUZXh0ID09PSAncmVxdWlyZScgJiZcbiAgICAgIHRzLmlzU3RyaW5nTGl0ZXJhbExpa2Uobm9kZS5hcmd1bWVudHNbMF0pXG4gICAgKSB7XG4gICAgICBjb25zdCBpbXBvcnRQYXRoOiBzdHJpbmcgPSAobm9kZS5hcmd1bWVudHNbMF0gYXMgdHMuU3RyaW5nTGl0ZXJhbExpa2UpXG4gICAgICAgIC50ZXh0O1xuICAgICAgY29uc3QgcmV3cml0dGVuSW1wb3J0UGF0aDogc3RyaW5nID0gcmV3cml0ZVNyY1BhdGgoe1xuICAgICAgICBpbXBvcnRQYXRoLFxuICAgICAgICBmaWxlUGF0aDogZmlsZU5hbWUgfHwgbm9kZS5nZXRTb3VyY2VGaWxlKCkuZmlsZU5hbWUsXG4gICAgICAgIHJvb3REaXI6IHNyYyxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoaW1wb3J0UGF0aCAhPT0gcmV3cml0dGVuSW1wb3J0UGF0aCkge1xuICAgICAgICByZXR1cm4gdHMuZmFjdG9yeS51cGRhdGVDYWxsRXhwcmVzc2lvbihcbiAgICAgICAgICBub2RlLFxuICAgICAgICAgIG5vZGUuZXhwcmVzc2lvbixcbiAgICAgICAgICBub2RlLnR5cGVBcmd1bWVudHMsXG4gICAgICAgICAgW1xuICAgICAgICAgICAgdHMuZmFjdG9yeS5jcmVhdGVTdHJpbmdMaXRlcmFsKHJld3JpdHRlbkltcG9ydFBhdGgpLFxuICAgICAgICAgICAgLi4ubm9kZS5hcmd1bWVudHMuc2xpY2UoMSksXG4gICAgICAgICAgXSxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gdHMudmlzaXRFYWNoQ2hpbGQobm9kZSwgdmlzaXRvciwgY3R4KTtcbiAgfTtcblxuICByZXR1cm4gdmlzaXRvcjtcbn1cblxuZXhwb3J0IGNvbnN0IGltcG9ydFBhdGhSZXdyaXRlID1cbiAgKGNvbmZpZzogQ29uZmlndXJhdGlvbik6IHRzLlRyYW5zZm9ybWVyRmFjdG9yeTx0cy5Tb3VyY2VGaWxlPiA9PlxuICAoY3R4OiB0cy5UcmFuc2Zvcm1hdGlvbkNvbnRleHQpID0+XG4gIChub2RlOiB0cy5Tb3VyY2VGaWxlKSA9PiB7XG4gICAgcmV0dXJuIHRzLnZpc2l0Tm9kZShub2RlLCBjcmVhdGVWaXNpdG9yKHsgLi4uY29uZmlnLCBjdHggfSkpO1xuICB9O1xuIl19