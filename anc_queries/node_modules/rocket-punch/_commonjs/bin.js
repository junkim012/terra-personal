"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.run = void 0;
const read_last_argv_1 = require("@ssen/read-last-argv");
const path_1 = __importDefault(require("path"));
const process = __importStar(require("process"));
const yargs_1 = __importDefault(require("yargs"));
const build_1 = require("./build");
const doctor_1 = require("./doctor");
const readEntry_1 = require("./entry/readEntry");
const build_2 = require("./message-handlers/build");
const doctor_2 = require("./message-handlers/doctor");
const publish_1 = require("./message-handlers/publish");
const view_1 = require("./message-handlers/view");
const publish_2 = require("./publish");
const view_2 = require("./view");
const cwd = process.cwd();
const commonOptions = {
    'emit': {
        type: 'boolean',
        default: true,
        describe: 'if you set this false it will only print options without run (e.g. --no-emit or --emit false)',
    },
    'source-root': {
        type: 'string',
        describe: 'source root (e.g. --source-root src)',
    },
};
const buildOptions = {
    'out-dir': {
        type: 'string',
        alias: 'o',
        describe: 'output directory (e.g. --out-dir out/packages)',
    },
    'show-packages-order': {
        type: 'boolean',
        default: false,
        describe: 'debug packages order',
    },
    'tsconfig': {
        type: 'string',
        alias: 't',
        describe: 'tsconfig file name (e.g. --tsconfig tsconfig.dev.json)',
    },
    'svg': {
        type: 'string',
        choices: ['create-react-app', 'default'],
        describe: 'svg compile type <default|create-react-app> (e.g. --svg default)',
    },
    'strict': {
        type: 'boolean',
        default: false,
        describe: 'if you set this true it will return exit 1 and stop build when there are tsc build warnings',
    },
};
const publishOptions = {
    'out-dir': buildOptions['out-dir'],
    'skip-selection': {
        type: 'boolean',
        alias: 's',
        describe: 'if true publish all packages without user selection',
    },
    'tag': {
        type: 'string',
        alias: 't',
        describe: 'npm publish --tag {tag}',
    },
    'access': {
        type: 'string',
        alias: 'a',
        describe: 'npm publish --access <public|private>',
    },
    'registry': {
        type: 'string',
        alias: 'r',
        describe: 'npm publish --registry {registry}',
    },
};
function toAbsolutePath(dir) {
    if (typeof dir !== 'string') {
        return undefined;
    }
    else if (path_1.default.isAbsolute(dir)) {
        return dir;
    }
    else {
        return path_1.default.join(cwd, dir);
    }
}
function run() {
    return yargs_1.default
        .command({
        command: 'build',
        describe: 'Build packages',
        builder: (argv) => argv
            .options({
            ...buildOptions,
            ...commonOptions,
        })
            .example('$0 build --out-dir /some/directory', 'Build packages to specific directory')
            .example('$0 build --tsconfig tsconfig.build.json', 'Use another tsconfig.json file on build')
            .example('$0 build --svg default', 'SVG transform to `import ReactComponent from "./file.svg"`'),
        handler: (argv) => {
            const { emit, outDir, tsconfig, sourceRoot, svg, strict, showPackagesOrder, } = read_last_argv_1.readLastArgv(argv);
            const params = {
                cwd,
                svg: svg === 'default' ? 'default' : 'create-react-app',
                dist: toAbsolutePath(outDir),
                showPackagesOrder: showPackagesOrder === true,
                tsconfig,
                sourceRoot,
                strict,
                entry: readEntry_1.readEntry({ cwd }),
                onMessage: build_2.buildMessageHandler,
            };
            if (emit) {
                build_1.build(params);
            }
            else {
                console.log(params);
            }
        },
    })
        .command({
        command: 'publish',
        describe: 'Publish packages',
        builder: (argv) => argv
            .options({
            ...publishOptions,
            ...commonOptions,
        })
            .example('$0 publish', 'Publish packages')
            .example('$0 publish --out-dir /some/directory', 'Publish packages from specific directory')
            .example('$0 publish --skip-selection', 'Publish all packages without user selection (e.g. CI)')
            .example('$0 publish --skip-selection --tag e2e --registry http://localhost:4873', 'E2E test'),
        handler: (argv) => {
            const { registry, outDir, sourceRoot, emit, access, skipSelection, tag, } = read_last_argv_1.readLastArgv(argv);
            const params = {
                cwd,
                dist: toAbsolutePath(outDir),
                entry: readEntry_1.readEntry({ cwd }),
                skipSelection,
                sourceRoot,
                tag,
                access: access === 'public' || access === 'private' ? access : undefined,
                registry,
                onMessage: publish_1.publishMessageHandler,
            };
            if (emit) {
                publish_2.publish(params);
            }
            else {
                console.log(params);
            }
        },
    })
        .command({
        command: 'view',
        describe: 'View packages information',
        builder: (argv) => argv
            .options({ ...commonOptions })
            .example('$0 view', 'View packages information'),
        handler: (argv) => {
            const { emit, sourceRoot } = read_last_argv_1.readLastArgv(argv);
            const params = {
                cwd,
                sourceRoot,
                entry: readEntry_1.readEntry({ cwd }),
                onMessage: view_1.viewMessageHandler,
            };
            if (emit) {
                view_2.view(params);
            }
            else {
                console.log(params);
            }
        },
    })
        .command({
        command: 'doctor',
        describe: 'Check configs is validate for rocket-punch',
        builder: (argv) => argv
            .options({ ...commonOptions })
            .example('$0 doctor', 'Check configs is validate for rocket-punch'),
        handler: (argv) => {
            const { emit, sourceRoot } = read_last_argv_1.readLastArgv(argv);
            const params = {
                cwd,
                sourceRoot,
                entry: readEntry_1.readEntry({ cwd }),
                onMessage: doctor_2.doctorMessageHandler,
            };
            if (emit) {
                doctor_1.doctor(params);
            }
            else {
                console.log(params);
            }
        },
    })
        .wrap(null)
        .help('h')
        .alias('h', 'help')
        .showHelpOnFail(true)
        .demandCommand()
        .recommendCommands()
        .strict()
        .epilog('ðŸš€ Rocket Punch!').argv;
}
exports.run = run;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL3JvY2tldC1wdW5jaC9iaW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLHlEQUFvRDtBQUNwRCxnREFBd0I7QUFDeEIsaURBQW1DO0FBQ25DLGtEQUErQztBQUMvQyxtQ0FBZ0M7QUFDaEMscUNBQWtDO0FBQ2xDLGlEQUE4QztBQUM5QyxvREFBK0Q7QUFDL0Qsc0RBQWlFO0FBQ2pFLHdEQUFtRTtBQUNuRSxrREFBNkQ7QUFFN0QsdUNBQW9DO0FBQ3BDLGlDQUE4QjtBQUU5QixNQUFNLEdBQUcsR0FBVyxPQUFPLENBQUMsR0FBRyxFQUFFLENBQUM7QUFTbEMsTUFBTSxhQUFhLEdBQVk7SUFDN0IsTUFBTSxFQUFFO1FBQ04sSUFBSSxFQUFFLFNBQVM7UUFDZixPQUFPLEVBQUUsSUFBSTtRQUNiLFFBQVEsRUFDTiwrRkFBK0Y7S0FDbEc7SUFDRCxhQUFhLEVBQUU7UUFDYixJQUFJLEVBQUUsUUFBUTtRQUNkLFFBQVEsRUFBRSxzQ0FBc0M7S0FDakQ7Q0FDRixDQUFDO0FBVUYsTUFBTSxZQUFZLEdBQVk7SUFDNUIsU0FBUyxFQUFFO1FBQ1QsSUFBSSxFQUFFLFFBQVE7UUFDZCxLQUFLLEVBQUUsR0FBRztRQUNWLFFBQVEsRUFBRSxnREFBZ0Q7S0FDM0Q7SUFDRCxxQkFBcUIsRUFBRTtRQUNyQixJQUFJLEVBQUUsU0FBUztRQUNmLE9BQU8sRUFBRSxLQUFLO1FBQ2QsUUFBUSxFQUFFLHNCQUFzQjtLQUNqQztJQUNELFVBQVUsRUFBRTtRQUNWLElBQUksRUFBRSxRQUFRO1FBQ2QsS0FBSyxFQUFFLEdBQUc7UUFDVixRQUFRLEVBQUUsd0RBQXdEO0tBQ25FO0lBQ0QsS0FBSyxFQUFFO1FBQ0wsSUFBSSxFQUFFLFFBQVE7UUFDZCxPQUFPLEVBQUUsQ0FBQyxrQkFBa0IsRUFBRSxTQUFTLENBQUM7UUFDeEMsUUFBUSxFQUNO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UUFDSCxDQUFDO0tBQ0YsQ0FBQztTQUNELElBQUksQ0FBQyxJQUFJLENBQUM7U0FDVixJQUFJLENBQUMsR0FBRyxDQUFDO1NBQ1QsS0FBSyxDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUM7U0FDbEIsY0FBYyxDQUFDLElBQUksQ0FBQztTQUNwQixhQUFhLEVBQUU7U0FDZixpQkFBaUIsRUFBRTtTQUNuQixNQUFNLEVBQUU7U0FDUixNQUFNLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxJQUFJLENBQUM7QUFDckMsQ0FBQztBQTlKRCxrQkE4SkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyByZWFkTGFzdEFyZ3YgfSBmcm9tICdAc3Nlbi9yZWFkLWxhc3QtYXJndic7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCAqIGFzIHByb2Nlc3MgZnJvbSAncHJvY2Vzcyc7XG5pbXBvcnQgeWFyZ3MsIHsgQXJndW1lbnRzLCBBcmd2IH0gZnJvbSAneWFyZ3MnO1xuaW1wb3J0IHsgYnVpbGQgfSBmcm9tICcuL2J1aWxkJztcbmltcG9ydCB7IGRvY3RvciB9IGZyb20gJy4vZG9jdG9yJztcbmltcG9ydCB7IHJlYWRFbnRyeSB9IGZyb20gJy4vZW50cnkvcmVhZEVudHJ5JztcbmltcG9ydCB7IGJ1aWxkTWVzc2FnZUhhbmRsZXIgfSBmcm9tICcuL21lc3NhZ2UtaGFuZGxlcnMvYnVpbGQnO1xuaW1wb3J0IHsgZG9jdG9yTWVzc2FnZUhhbmRsZXIgfSBmcm9tICcuL21lc3NhZ2UtaGFuZGxlcnMvZG9jdG9yJztcbmltcG9ydCB7IHB1Ymxpc2hNZXNzYWdlSGFuZGxlciB9IGZyb20gJy4vbWVzc2FnZS1oYW5kbGVycy9wdWJsaXNoJztcbmltcG9ydCB7IHZpZXdNZXNzYWdlSGFuZGxlciB9IGZyb20gJy4vbWVzc2FnZS1oYW5kbGVycy92aWV3JztcbmltcG9ydCB7IEJ1aWxkUGFyYW1zLCBEb2N0b3JQYXJhbXMsIFB1Ymxpc2hQYXJhbXMsIFZpZXdQYXJhbXMgfSBmcm9tICcuL3BhcmFtcyc7XG5pbXBvcnQgeyBwdWJsaXNoIH0gZnJvbSAnLi9wdWJsaXNoJztcbmltcG9ydCB7IHZpZXcgfSBmcm9tICcuL3ZpZXcnO1xuXG5jb25zdCBjd2Q6IHN0cmluZyA9IHByb2Nlc3MuY3dkKCk7XG5cbnR5cGUgT3B0aW9ucyA9IFBhcmFtZXRlcnM8QXJndlsnb3B0aW9ucyddPlswXTtcblxudHlwZSBDb21tb25BcmdzID0ge1xuICBlbWl0PzogYm9vbGVhbjtcbiAgc291cmNlUm9vdD86IHN0cmluZztcbn07XG5cbmNvbnN0IGNvbW1vbk9wdGlvbnM6IE9wdGlvbnMgPSB7XG4gICdlbWl0Jzoge1xuICAgIHR5cGU6ICdib29sZWFuJyxcbiAgICBkZWZhdWx0OiB0cnVlLFxuICAgIGRlc2NyaWJlOlxuICAgICAgJ2lmIHlvdSBzZXQgdGhpcyBmYWxzZSBpdCB3aWxsIG9ubHkgcHJpbnQgb3B0aW9ucyB3aXRob3V0IHJ1biAoZS5nLiAtLW5vLWVtaXQgb3IgLS1lbWl0IGZhbHNlKScsXG4gIH0sXG4gICdzb3VyY2Utcm9vdCc6IHtcbiAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICBkZXNjcmliZTogJ3NvdXJjZSByb290IChlLmcuIC0tc291cmNlLXJvb3Qgc3JjKScsXG4gIH0sXG59O1xuXG50eXBlIEJ1aWxkQXJncyA9IHtcbiAgb3V0RGlyPzogc3RyaW5nO1xuICB0c2NvbmZpZz86IHN0cmluZztcbiAgc3ZnPzogc3RyaW5nO1xuICBzdHJpY3Q/OiBib29sZWFuO1xuICBzaG93UGFja2FnZXNPcmRlcj86IGJvb2xlYW47XG59O1xuXG5jb25zdCBidWlsZE9wdGlvbnM6IE9wdGlvbnMgPSB7XG4gICdvdXQtZGlyJzoge1xuICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgIGFsaWFzOiAnbycsXG4gICAgZGVzY3JpYmU6ICdvdXRwdXQgZGlyZWN0b3J5IChlLmcuIC0tb3V0LWRpciBvdXQvcGFja2FnZXMpJyxcbiAgfSxcbiAgJ3Nob3ctcGFja2FnZXMtb3JkZXInOiB7XG4gICAgdHlwZTogJ2Jvb2xlYW4nLFxuICAgIGRlZmF1bHQ6IGZhbHNlLFxuICAgIGRlc2NyaWJlOiAnZGVidWcgcGFja2FnZXMgb3JkZXInLFxuICB9LFxuICAndHNjb25maWcnOiB7XG4gICAgdHlwZTogJ3N0cmluZycsXG4gICAgYWxpYXM6ICd0JyxcbiAgICBkZXNjcmliZTogJ3RzY29uZmlnIGZpbGUgbmFtZSAoZS5nLiAtLXRzY29uZmlnIHRzY29uZmlnLmRldi5qc29uKScsXG4gIH0sXG4gICdzdmcnOiB7XG4gICAgdHlwZTogJ3N0cmluZycsXG4gICAgY2hvaWNlczogWydjcmVhdGUtcmVhY3QtYXBwJywgJ2RlZmF1bHQnXSxcbiAgICBkZXNjcmliZTpcbiAgICAgICdzdmcgY29tcGlsZSB0eXBlIDxkZWZhdWx0fGNyZWF0ZS1yZWFjdC1hcHA+IChlLmcuIC0tc3ZnIGRlZmF1bHQpJyxcbiAgfSxcbiAgJ3N0cmljdCc6IHtcbiAgICB0eXBlOiAnYm9vbGVhbicsXG4gICAgZGVmYXVsdDogZmFsc2UsXG4gICAgZGVzY3JpYmU6XG4gICAgICAnaWYgeW91IHNldCB0aGlzIHRydWUgaXQgd2lsbCByZXR1cm4gZXhpdCAxIGFuZCBzdG9wIGJ1aWxkIHdoZW4gdGhlcmUgYXJlIHRzYyBidWlsZCB3YXJuaW5ncycsXG4gIH0sXG59O1xuXG50eXBlIFB1Ymxpc2hBcmdzID0ge1xuICBvdXREaXI/OiBzdHJpbmc7XG4gIHNraXBTZWxlY3Rpb24/OiBib29sZWFuO1xuICB0YWc/OiBzdHJpbmc7XG4gIGFjY2Vzcz86IHN0cmluZztcbiAgcmVnaXN0cnk/OiBzdHJpbmc7XG59O1xuXG5jb25zdCBwdWJsaXNoT3B0aW9uczogT3B0aW9ucyA9IHtcbiAgJ291dC1kaXInOiBidWlsZE9wdGlvbnNbJ291dC1kaXInXSxcbiAgJ3NraXAtc2VsZWN0aW9uJzoge1xuICAgIHR5cGU6ICdib29sZWFuJyxcbiAgICBhbGlhczogJ3MnLFxuICAgIGRlc2NyaWJlOiAnaWYgdHJ1ZSBwdWJsaXNoIGFsbCBwYWNrYWdlcyB3aXRob3V0IHVzZXIgc2VsZWN0aW9uJyxcbiAgfSxcbiAgJ3RhZyc6IHtcbiAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICBhbGlhczogJ3QnLFxuICAgIGRlc2NyaWJlOiAnbnBtIHB1Ymxpc2ggLS10YWcge3RhZ30nLFxuICB9LFxuICAnYWNjZXNzJzoge1xuICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgIGFsaWFzOiAnYScsXG4gICAgZGVzY3JpYmU6ICducG0gcHVibGlzaCAtLWFjY2VzcyA8cHVibGljfHByaXZhdGU+JyxcbiAgfSxcbiAgJ3JlZ2lzdHJ5Jzoge1xuICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgIGFsaWFzOiAncicsXG4gICAgZGVzY3JpYmU6ICducG0gcHVibGlzaCAtLXJlZ2lzdHJ5IHtyZWdpc3RyeX0nLFxuICB9LFxufTtcblxuZnVuY3Rpb24gdG9BYnNvbHV0ZVBhdGgoZGlyOiBzdHJpbmcgfCB1bmRlZmluZWQpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICBpZiAodHlwZW9mIGRpciAhPT0gJ3N0cmluZycpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9IGVsc2UgaWYgKHBhdGguaXNBYnNvbHV0ZShkaXIpKSB7XG4gICAgcmV0dXJuIGRpcjtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gcGF0aC5qb2luKGN3ZCwgZGlyKTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcnVuKCkge1xuICByZXR1cm4geWFyZ3NcbiAgICAuY29tbWFuZCh7XG4gICAgICBjb21tYW5kOiAnYnVpbGQnLFxuICAgICAgZGVzY3JpYmU6ICdCdWlsZCBwYWNrYWdlcycsXG4gICAgICBidWlsZGVyOiAoYXJndikgPT5cbiAgICAgICAgYXJndlxuICAgICAgICAgIC5vcHRpb25zKHtcbiAgICAgICAgICAgIC4uLmJ1aWxkT3B0aW9ucyxcbiAgICAgICAgICAgIC4uLmNvbW1vbk9wdGlvbnMsXG4gICAgICAgICAgfSlcbiAgICAgICAgICAuZXhhbXBsZShcbiAgICAgICAgICAgICckMCBidWlsZCAtLW91dC1kaXIgL3NvbWUvZGlyZWN0b3J5JyxcbiAgICAgICAgICAgICdCdWlsZCBwYWNrYWdlcyB0byBzcGVjaWZpYyBkaXJlY3RvcnknLFxuICAgICAgICAgIClcbiAgICAgICAgICAuZXhhbXBsZShcbiAgICAgICAgICAgICckMCBidWlsZCAtLXRzY29uZmlnIHRzY29uZmlnLmJ1aWxkLmpzb24nLFxuICAgICAgICAgICAgJ1VzZSBhbm90aGVyIHRzY29uZmlnLmpzb24gZmlsZSBvbiBidWlsZCcsXG4gICAgICAgICAgKVxuICAgICAgICAgIC5leGFtcGxlKFxuICAgICAgICAgICAgJyQwIGJ1aWxkIC0tc3ZnIGRlZmF1bHQnLFxuICAgICAgICAgICAgJ1NWRyB0cmFuc2Zvcm0gdG8gYGltcG9ydCBSZWFjdENvbXBvbmVudCBmcm9tIFwiLi9maWxlLnN2Z1wiYCcsXG4gICAgICAgICAgKSxcbiAgICAgIGhhbmRsZXI6IChhcmd2OiBBcmd1bWVudHM8Q29tbW9uQXJncyAmIEJ1aWxkQXJncz4pID0+IHtcbiAgICAgICAgY29uc3Qge1xuICAgICAgICAgIGVtaXQsXG4gICAgICAgICAgb3V0RGlyLFxuICAgICAgICAgIHRzY29uZmlnLFxuICAgICAgICAgIHNvdXJjZVJvb3QsXG4gICAgICAgICAgc3ZnLFxuICAgICAgICAgIHN0cmljdCxcbiAgICAgICAgICBzaG93UGFja2FnZXNPcmRlcixcbiAgICAgICAgfSA9IHJlYWRMYXN0QXJndihhcmd2KTtcbiAgICAgICAgY29uc3QgcGFyYW1zOiBCdWlsZFBhcmFtcyA9IHtcbiAgICAgICAgICBjd2QsXG4gICAgICAgICAgc3ZnOiBzdmcgPT09ICdkZWZhdWx0JyA/ICdkZWZhdWx0JyA6ICdjcmVhdGUtcmVhY3QtYXBwJyxcbiAgICAgICAgICBkaXN0OiB0b0Fic29sdXRlUGF0aChvdXREaXIpLFxuICAgICAgICAgIHNob3dQYWNrYWdlc09yZGVyOiBzaG93UGFja2FnZXNPcmRlciA9PT0gdHJ1ZSxcbiAgICAgICAgICB0c2NvbmZpZyxcbiAgICAgICAgICBzb3VyY2VSb290LFxuICAgICAgICAgIHN0cmljdCxcbiAgICAgICAgICBlbnRyeTogcmVhZEVudHJ5KHsgY3dkIH0pLFxuICAgICAgICAgIG9uTWVzc2FnZTogYnVpbGRNZXNzYWdlSGFuZGxlcixcbiAgICAgICAgfTtcblxuICAgICAgICBpZiAoZW1pdCkge1xuICAgICAgICAgIGJ1aWxkKHBhcmFtcyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc29sZS5sb2cocGFyYW1zKTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICB9KVxuICAgIC5jb21tYW5kKHtcbiAgICAgIGNvbW1hbmQ6ICdwdWJsaXNoJyxcbiAgICAgIGRlc2NyaWJlOiAnUHVibGlzaCBwYWNrYWdlcycsXG4gICAgICBidWlsZGVyOiAoYXJndikgPT5cbiAgICAgICAgYXJndlxuICAgICAgICAgIC5vcHRpb25zKHtcbiAgICAgICAgICAgIC4uLnB1Ymxpc2hPcHRpb25zLFxuICAgICAgICAgICAgLi4uY29tbW9uT3B0aW9ucyxcbiAgICAgICAgICB9KVxuICAgICAgICAgIC5leGFtcGxlKCckMCBwdWJsaXNoJywgJ1B1Ymxpc2ggcGFja2FnZXMnKVxuICAgICAgICAgIC5leGFtcGxlKFxuICAgICAgICAgICAgJyQwIHB1Ymxpc2ggLS1vdXQtZGlyIC9zb21lL2RpcmVjdG9yeScsXG4gICAgICAgICAgICAnUHVibGlzaCBwYWNrYWdlcyBmcm9tIHNwZWNpZmljIGRpcmVjdG9yeScsXG4gICAgICAgICAgKVxuICAgICAgICAgIC5leGFtcGxlKFxuICAgICAgICAgICAgJyQwIHB1Ymxpc2ggLS1za2lwLXNlbGVjdGlvbicsXG4gICAgICAgICAgICAnUHVibGlzaCBhbGwgcGFja2FnZXMgd2l0aG91dCB1c2VyIHNlbGVjdGlvbiAoZS5nLiBDSSknLFxuICAgICAgICAgIClcbiAgICAgICAgICAuZXhhbXBsZShcbiAgICAgICAgICAgICckMCBwdWJsaXNoIC0tc2tpcC1zZWxlY3Rpb24gLS10YWcgZTJlIC0tcmVnaXN0cnkgaHR0cDovL2xvY2FsaG9zdDo0ODczJyxcbiAgICAgICAgICAgICdFMkUgdGVzdCcsXG4gICAgICAgICAgKSxcbiAgICAgIGhhbmRsZXI6IChhcmd2OiBBcmd1bWVudHM8Q29tbW9uQXJncyAmIFB1Ymxpc2hBcmdzPikgPT4ge1xuICAgICAgICBjb25zdCB7XG4gICAgICAgICAgcmVnaXN0cnksXG4gICAgICAgICAgb3V0RGlyLFxuICAgICAgICAgIHNvdXJjZVJvb3QsXG4gICAgICAgICAgZW1pdCxcbiAgICAgICAgICBhY2Nlc3MsXG4gICAgICAgICAgc2tpcFNlbGVjdGlvbixcbiAgICAgICAgICB0YWcsXG4gICAgICAgIH0gPSByZWFkTGFzdEFyZ3YoYXJndik7XG4gICAgICAgIGNvbnN0IHBhcmFtczogUHVibGlzaFBhcmFtcyA9IHtcbiAgICAgICAgICBjd2QsXG4gICAgICAgICAgZGlzdDogdG9BYnNvbHV0ZVBhdGgob3V0RGlyKSxcbiAgICAgICAgICBlbnRyeTogcmVhZEVudHJ5KHsgY3dkIH0pLFxuICAgICAgICAgIHNraXBTZWxlY3Rpb24sXG4gICAgICAgICAgc291cmNlUm9vdCxcbiAgICAgICAgICB0YWcsXG4gICAgICAgICAgYWNjZXNzOlxuICAgICAgICAgICAgYWNjZXNzID09PSAncHVibGljJyB8fCBhY2Nlc3MgPT09ICdwcml2YXRlJyA/IGFjY2VzcyA6IHVuZGVmaW5lZCxcbiAgICAgICAgICByZWdpc3RyeSxcbiAgICAgICAgICBvbk1lc3NhZ2U6IHB1Ymxpc2hNZXNzYWdlSGFuZGxlcixcbiAgICAgICAgfTtcblxuICAgICAgICBpZiAoZW1pdCkge1xuICAgICAgICAgIHB1Ymxpc2gocGFyYW1zKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zb2xlLmxvZyhwYXJhbXMpO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgIH0pXG4gICAgLmNvbW1hbmQoe1xuICAgICAgY29tbWFuZDogJ3ZpZXcnLFxuICAgICAgZGVzY3JpYmU6ICdWaWV3IHBhY2thZ2VzIGluZm9ybWF0aW9uJyxcbiAgICAgIGJ1aWxkZXI6IChhcmd2KSA9PlxuICAgICAgICBhcmd2XG4gICAgICAgICAgLm9wdGlvbnMoeyAuLi5jb21tb25PcHRpb25zIH0pXG4gICAgICAgICAgLmV4YW1wbGUoJyQwIHZpZXcnLCAnVmlldyBwYWNrYWdlcyBpbmZvcm1hdGlvbicpLFxuICAgICAgaGFuZGxlcjogKGFyZ3Y6IEFyZ3VtZW50czxDb21tb25BcmdzPikgPT4ge1xuICAgICAgICBjb25zdCB7IGVtaXQsIHNvdXJjZVJvb3QgfSA9IHJlYWRMYXN0QXJndihhcmd2KTtcbiAgICAgICAgY29uc3QgcGFyYW1zOiBWaWV3UGFyYW1zID0ge1xuICAgICAgICAgIGN3ZCxcbiAgICAgICAgICBzb3VyY2VSb290LFxuICAgICAgICAgIGVudHJ5OiByZWFkRW50cnkoeyBjd2QgfSksXG4gICAgICAgICAgb25NZXNzYWdlOiB2aWV3TWVzc2FnZUhhbmRsZXIsXG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKGVtaXQpIHtcbiAgICAgICAgICB2aWV3KHBhcmFtcyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc29sZS5sb2cocGFyYW1zKTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICB9KVxuICAgIC5jb21tYW5kKHtcbiAgICAgIGNvbW1hbmQ6ICdkb2N0b3InLFxuICAgICAgZGVzY3JpYmU6ICdDaGVjayBjb25maWdzIGlzIHZhbGlkYXRlIGZvciByb2NrZXQtcHVuY2gnLFxuICAgICAgYnVpbGRlcjogKGFyZ3YpID0+XG4gICAgICAgIGFyZ3ZcbiAgICAgICAgICAub3B0aW9ucyh7IC4uLmNvbW1vbk9wdGlvbnMgfSlcbiAgICAgICAgICAuZXhhbXBsZSgnJDAgZG9jdG9yJywgJ0NoZWNrIGNvbmZpZ3MgaXMgdmFsaWRhdGUgZm9yIHJvY2tldC1wdW5jaCcpLFxuICAgICAgaGFuZGxlcjogKGFyZ3Y6IEFyZ3VtZW50czxDb21tb25BcmdzPikgPT4ge1xuICAgICAgICBjb25zdCB7IGVtaXQsIHNvdXJjZVJvb3QgfSA9IHJlYWRMYXN0QXJndihhcmd2KTtcbiAgICAgICAgY29uc3QgcGFyYW1zOiBEb2N0b3JQYXJhbXMgPSB7XG4gICAgICAgICAgY3dkLFxuICAgICAgICAgIHNvdXJjZVJvb3QsXG4gICAgICAgICAgZW50cnk6IHJlYWRFbnRyeSh7IGN3ZCB9KSxcbiAgICAgICAgICBvbk1lc3NhZ2U6IGRvY3Rvck1lc3NhZ2VIYW5kbGVyLFxuICAgICAgICB9O1xuXG4gICAgICAgIGlmIChlbWl0KSB7XG4gICAgICAgICAgZG9jdG9yKHBhcmFtcyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc29sZS5sb2cocGFyYW1zKTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICB9KVxuICAgIC53cmFwKG51bGwpXG4gICAgLmhlbHAoJ2gnKVxuICAgIC5hbGlhcygnaCcsICdoZWxwJylcbiAgICAuc2hvd0hlbHBPbkZhaWwodHJ1ZSlcbiAgICAuZGVtYW5kQ29tbWFuZCgpXG4gICAgLnJlY29tbWVuZENvbW1hbmRzKClcbiAgICAuc3RyaWN0KClcbiAgICAuZXBpbG9nKCfwn5qAIFJvY2tldCBQdW5jaCEnKS5hcmd2O1xufVxuIl19