"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.view = void 0;
const package_json_1 = __importDefault(require("package-json"));
const process_1 = __importDefault(require("process"));
const readPackages_1 = require("./entry/readPackages");
const view_1 = require("./message-handlers/view");
async function view({ cwd = process_1.default.cwd(), sourceRoot = 'src', entry, onMessage = view_1.viewMessageHandler, }) {
    const internalPackages = await readPackages_1.readPackages({
        cwd,
        sourceRoot,
        entry,
    });
    const originMetadatas = await Promise.all(Array.from(internalPackages.keys()).map((name) => package_json_1.default(name, {
        fullMetadata: true,
        allVersions: true,
    }).catch(() => undefined)));
    const metadatas = originMetadatas.filter((metadata) => !!metadata);
    for (const metadata of metadatas) {
        if (!internalPackages.has(metadata.name)) {
            throw new Error(`undefined package ${metadata.name}`);
        }
        const info = internalPackages.get(metadata.name);
        const tags = metadata['dist-tags'];
        await onMessage({
            type: 'view',
            metadata,
            tags,
            packageConfig: info,
        });
    }
}
exports.view = view;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlldy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9yb2NrZXQtcHVuY2gvdmlldy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxnRUFBNEQ7QUFDNUQsc0RBQThCO0FBQzlCLHVEQUFvRDtBQUNwRCxrREFBNkQ7QUFJdEQsS0FBSyxVQUFVLElBQUksQ0FBQyxFQUN6QixHQUFHLEdBQUcsaUJBQU8sQ0FBQyxHQUFHLEVBQUUsRUFDbkIsVUFBVSxHQUFHLEtBQUssRUFDbEIsS0FBSyxFQUNMLFNBQVMsR0FBRyx5QkFBa0IsR0FDbkI7SUFDWCxNQUFNLGdCQUFnQixHQUE2QixNQUFNLDJCQUFZLENBQUM7UUFDcEUsR0FBRztRQUNILFVBQVU7UUFDVixLQUFLO0tBQ04sQ0FBQyxDQUFDO0lBRUgsTUFBTSxlQUFlLEdBQWlDLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FDckUsS0FBSyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQy9DLHNCQUFjLENBQUMsSUFBSSxFQUFFO1FBQ25CLFlBQVksRUFBRSxJQUFJO1FBQ2xCLFdBQVcsRUFBRSxJQUFJO0tBQ2xCLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUMsU0FBUyxDQUFDLENBQzFCLENBQ0YsQ0FBQztJQUVGLE1BQU0sU0FBUyxHQUFtQixlQUFlLENBQUMsTUFBTSxDQUN0RCxDQUFDLFFBQVEsRUFBNEIsRUFBRSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQ25ELENBQUM7SUFFRixLQUFLLE1BQU0sUUFBUSxJQUFJLFNBQVMsRUFBRTtRQUNoQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUN4QyxNQUFNLElBQUksS0FBSyxDQUFDLHFCQUFxQixRQUFRLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztTQUN2RDtRQUVELE1BQU0sSUFBSSxHQUFnQixnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBRSxDQUFDO1FBQy9ELE1BQU0sSUFBSSxHQUEyQixRQUFRLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFM0QsTUFBTSxTQUFTLENBQUM7WUFDZCxJQUFJLEVBQUUsTUFBTTtZQUNaLFFBQVE7WUFDUixJQUFJO1lBQ0osYUFBYSxFQUFFLElBQUk7U0FDcEIsQ0FBQyxDQUFDO0tBQ0o7QUFDSCxDQUFDO0FBeENELG9CQXdDQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBnZXRQYWNrYWdlSnNvbiwgeyBGdWxsTWV0YWRhdGEgfSBmcm9tICdwYWNrYWdlLWpzb24nO1xuaW1wb3J0IHByb2Nlc3MgZnJvbSAncHJvY2Vzcyc7XG5pbXBvcnQgeyByZWFkUGFja2FnZXMgfSBmcm9tICcuL2VudHJ5L3JlYWRQYWNrYWdlcyc7XG5pbXBvcnQgeyB2aWV3TWVzc2FnZUhhbmRsZXIgfSBmcm9tICcuL21lc3NhZ2UtaGFuZGxlcnMvdmlldyc7XG5pbXBvcnQgeyBWaWV3UGFyYW1zIH0gZnJvbSAnLi9wYXJhbXMnO1xuaW1wb3J0IHsgUGFja2FnZUluZm8gfSBmcm9tICcuL3R5cGVzJztcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHZpZXcoe1xuICBjd2QgPSBwcm9jZXNzLmN3ZCgpLFxuICBzb3VyY2VSb290ID0gJ3NyYycsXG4gIGVudHJ5LFxuICBvbk1lc3NhZ2UgPSB2aWV3TWVzc2FnZUhhbmRsZXIsXG59OiBWaWV3UGFyYW1zKSB7XG4gIGNvbnN0IGludGVybmFsUGFja2FnZXM6IE1hcDxzdHJpbmcsIFBhY2thZ2VJbmZvPiA9IGF3YWl0IHJlYWRQYWNrYWdlcyh7XG4gICAgY3dkLFxuICAgIHNvdXJjZVJvb3QsXG4gICAgZW50cnksXG4gIH0pO1xuXG4gIGNvbnN0IG9yaWdpbk1ldGFkYXRhczogKEZ1bGxNZXRhZGF0YSB8IHVuZGVmaW5lZClbXSA9IGF3YWl0IFByb21pc2UuYWxsKFxuICAgIEFycmF5LmZyb20oaW50ZXJuYWxQYWNrYWdlcy5rZXlzKCkpLm1hcCgobmFtZSkgPT5cbiAgICAgIGdldFBhY2thZ2VKc29uKG5hbWUsIHtcbiAgICAgICAgZnVsbE1ldGFkYXRhOiB0cnVlLFxuICAgICAgICBhbGxWZXJzaW9uczogdHJ1ZSxcbiAgICAgIH0pLmNhdGNoKCgpID0+IHVuZGVmaW5lZCksXG4gICAgKSxcbiAgKTtcblxuICBjb25zdCBtZXRhZGF0YXM6IEZ1bGxNZXRhZGF0YVtdID0gb3JpZ2luTWV0YWRhdGFzLmZpbHRlcihcbiAgICAobWV0YWRhdGEpOiBtZXRhZGF0YSBpcyBGdWxsTWV0YWRhdGEgPT4gISFtZXRhZGF0YSxcbiAgKTtcblxuICBmb3IgKGNvbnN0IG1ldGFkYXRhIG9mIG1ldGFkYXRhcykge1xuICAgIGlmICghaW50ZXJuYWxQYWNrYWdlcy5oYXMobWV0YWRhdGEubmFtZSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgdW5kZWZpbmVkIHBhY2thZ2UgJHttZXRhZGF0YS5uYW1lfWApO1xuICAgIH1cblxuICAgIGNvbnN0IGluZm86IFBhY2thZ2VJbmZvID0gaW50ZXJuYWxQYWNrYWdlcy5nZXQobWV0YWRhdGEubmFtZSkhO1xuICAgIGNvbnN0IHRhZ3M6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSBtZXRhZGF0YVsnZGlzdC10YWdzJ107XG5cbiAgICBhd2FpdCBvbk1lc3NhZ2Uoe1xuICAgICAgdHlwZTogJ3ZpZXcnLFxuICAgICAgbWV0YWRhdGEsXG4gICAgICB0YWdzLFxuICAgICAgcGFja2FnZUNvbmZpZzogaW5mbyxcbiAgICB9KTtcbiAgfVxufVxuIl19